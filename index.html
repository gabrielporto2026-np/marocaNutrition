<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriVision Pro - Sistema de Nutrição Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* ===== VARIÁVEIS GLOBAIS ===== */
        :root {
            --primary-color: #2A9D8F;
            --primary-light: #4ECDC4;
            --primary-dark: #1D7873;
            --secondary-color: #E9C46A;
            --accent-color: #264653;
            --light-color: #F8F9FA;
            --dark-color: #343A40;
            --gray-color: #6C757D;
            --light-gray: #E9ECEF;
            --success-color: #2A9D8F;
            --warning-color: #E9C46A;
            --danger-color: #E76F51;
            --info-color: #457B9D;
            --border-radius: 12px;
            --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===== RESET E BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark-color);
            line-height: 1.7;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* ===== HEADER ===== */
        header {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-dark) 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            box-shadow: 0 4px 15px rgba(42, 157, 143, 0.3);
            position: relative;
            overflow: hidden;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            width: 60%;
            height: 60%;
            background: var(--primary-color);
            border-radius: 50%;
            transform: rotate(45deg);
        }

        .logo-icon i {
            position: relative;
            z-index: 1;
        }

        .logo-text h1 {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo-text p {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.9rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 25px;
            backdrop-filter: blur(5px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .user-details p {
            color: white;
            line-height: 1.3;
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
            margin: 30px 0;
            min-height: calc(100vh - 200px);
        }

        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px 0;
            height: fit-content;
            position: sticky;
            top: 100px;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
        }

        .sidebar h3 {
            color: var(--accent-color);
            margin: 0 25px 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin: 5px 15px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: var(--dark-color);
            text-decoration: none;
            border-radius: 10px;
            transition: var(--transition);
            font-weight: 500;
        }

        .nav-link:hover {
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, rgba(233, 196, 106, 0.1) 100%);
            transform: translateX(5px);
            color: var(--primary-color);
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(42, 157, 143, 0.3);
        }

        .nav-link i {
            width: 24px;
            text-align: center;
            font-size: 1.2rem;
        }

        /* ===== ÁREA DE CONTEÚDO ===== */
        .content-area {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 35px;
            min-height: 600px;
            position: relative;
            overflow: hidden;
        }

        .content-area::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.05) 0%, rgba(233, 196, 106, 0.05) 100%);
            border-radius: 0 0 0 100%;
        }

        .page-title {
            color: var(--accent-color);
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-title h2 {
            font-size: 1.8rem;
            font-weight: 700;
            position: relative;
            display: inline-block;
        }

        .page-title h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border-radius: 3px;
        }

        /* ===== CARDS DO DASHBOARD ===== */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px 25px;
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        }

        .card i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            position: relative;
            display: inline-block;
        }

        .card i::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(42, 157, 143, 0.1);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
        }

        .card h3 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            color: var(--accent-color);
            font-weight: 700;
        }

        .card p {
            color: var(--gray-color);
            font-size: 0.95rem;
        }

        /* ===== BOTÕES ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(42, 157, 143, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(42, 157, 143, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #FFD166 100%);
            box-shadow: 0 4px 15px rgba(233, 196, 106, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(233, 196, 106, 0.4);
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent-color) 0%, #457B9D 100%);
            box-shadow: 0 4px 15px rgba(38, 70, 83, 0.3);
        }

        .btn-accent:hover {
            box-shadow: 0 8px 25px rgba(38, 70, 83, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #F4A261 100%);
            box-shadow: 0 4px 15px rgba(231, 111, 81, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(231, 111, 81, 0.4);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* ===== TABELAS ===== */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--light-gray);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        table thead {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-dark) 100%);
        }

        table th {
            color: white;
            text-align: left;
            padding: 18px 20px;
            font-weight: 600;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        table th:first-child {
            border-radius: var(--border-radius) 0 0 0;
        }

        table th:last-child {
            border-radius: 0 var(--border-radius) 0 0;
        }

        table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--light-gray);
            vertical-align: middle;
        }

        table tr:hover {
            background-color: rgba(42, 157, 143, 0.05);
        }

        table tr:last-child td {
            border-bottom: none;
        }

        /* ===== FORMULÁRIOS ===== */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 4px rgba(42, 157, 143, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            line-height: 1.5;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        /* ===== MODAIS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 40px;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray-color);
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal:hover {
            color: var(--danger-color);
            background: rgba(231, 111, 81, 0.1);
        }

        .modal-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-gray);
        }

        .modal-header h3 {
            color: var(--accent-color);
            font-size: 1.8rem;
            font-weight: 700;
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--light-gray);
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
            position: relative;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== AVALIAÇÃO ANTROPOMÉTRICA ===== */
        .assessment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .measurement-group {
            background: linear-gradient(135deg, rgba(248, 249, 250, 0.8) 0%, rgba(233, 236, 239, 0.8) 100%);
            border-radius: var(--border-radius);
            padding: 25px;
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .measurement-group:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
        }

        .measurement-group h4 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .measurement-inputs {
            display: grid;
            gap: 15px;
        }

        .measurement-input {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .measurement-input label {
            min-width: 180px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.95rem;
        }

        .measurement-input input {
            width: 120px;
            padding: 10px 15px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
            transition: var(--transition);
        }

        .measurement-input input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.1);
        }

        /* ===== IMC INDICATORS ===== */
        .imc-indicator {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .imc-abaixo {
            background: linear-gradient(135deg, #FFE0B2 0%, #FFCC80 100%);
            color: #EF6C00;
        }

        .imc-eutrofico {
            background: linear-gradient(135deg, #C8E6C9 0%, #A5D6A7 100%);
            color: #2E7D32;
        }

        .imc-sobrepeso {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            color: #F57C00;
        }

        .imc-obesidade {
            background: linear-gradient(135deg, #FFCDD2 0%, #EF9A9A 100%);
            color: #C62828;
        }

        /* ===== TABELA TACO ===== */
        .taco-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-container {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .search-container input {
            width: 100%;
            padding: 14px 20px 14px 45px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-container input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 4px rgba(42, 157, 143, 0.1);
        }

        /* ===== PREPAROS ===== */
        .preparations-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .preparation-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .preparation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .preparation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        }

        .preparation-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .preparation-name {
            font-size: 1.3rem;
            color: var(--accent-color);
            font-weight: 700;
            margin-right: 10px;
        }

        .preparation-category {
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, rgba(42, 157, 143, 0.2) 100%);
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .preparation-description {
            color: var(--gray-color);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .ingredients-list {
            background: rgba(248, 249, 250, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .ingredients-list h5 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--light-gray);
        }

        .ingredient-item:last-child {
            border-bottom: none;
        }

        .ingredient-name {
            font-weight: 500;
        }

        .ingredient-quantity {
            color: var(--primary-color);
            font-weight: 600;
        }

        /* ===== EXPORT BUTTONS ===== */
        .export-section {
            background: linear-gradient(135deg, rgba(248, 249, 250, 0.8) 0%, rgba(233, 236, 239, 0.8) 100%);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-top: 40px;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .export-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 18px;
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
        }

        .export-btn:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
            border-color: var(--primary-color);
        }

        .export-btn i {
            font-size: 1.5rem;
        }

        .export-pdf:hover {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(231, 76, 60, 0.05) 100%);
            color: #E74C3C;
            border-color: #E74C3C;
        }

        .export-excel:hover {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, rgba(46, 204, 113, 0.05) 100%);
            color: #2ECC71;
            border-color: #2ECC71;
        }

        /* ===== MESSAGES ===== */
        .message {
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .message.success {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, rgba(46, 204, 113, 0.05) 100%);
            color: #27AE60;
            border-left-color: #2ECC71;
        }

        .message.error {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(231, 76, 60, 0.05) 100%);
            color: #C0392B;
            border-left-color: #E74C3C;
        }

        .message.info {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(52, 152, 219, 0.05) 100%);
            color: #2980B9;
            border-left-color: #3498DB;
        }

        /* ===== LOADING ===== */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: var(--gray-color);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(42, 157, 143, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== FOOTER ===== */
        footer {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-dark) 100%);
            padding: 40px 0;
            margin-top: 50px;
            color: white;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .footer-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .footer-logo i {
            font-size: 2rem;
            color: var(--secondary-color);
        }

        .footer-links {
            display: flex;
            gap: 20px;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-links a:hover {
            color: white;
            text-decoration: underline;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .main-content {
                margin: 20px 0;
            }
            
            .content-area {
                padding: 25px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
            }
            
            .export-buttons {
                grid-template-columns: 1fr;
            }
            
            .preparations-container {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 25px;
            }
            
            .tabs {
                overflow-x: auto;
                padding-bottom: 10px;
            }
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--warning-color) 100%);
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .badge-success {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.2) 0%, rgba(46, 204, 113, 0.1) 100%);
            color: #27AE60;
        }

        .badge-warning {
            background: linear-gradient(135deg, rgba(241, 196, 15, 0.2) 0%, rgba(241, 196, 15, 0.1) 100%);
            color: #F39C12;
        }

        .badge-danger {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.2) 0%, rgba(231, 76, 60, 0.1) 100%);
            color: #C0392B;
        }

        .badge-info {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.2) 0%, rgba(52, 152, 219, 0.1) 100%);
            color: #2980B9;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-apple-alt"></i>
                </div>
                <div class="logo-text">
                    <h1>NutriVision Pro</h1>
                    <p>Sistema avançado de nutrição clínica</p>
                </div>
            </div>
            
            <div class="user-info">
                <div class="user-avatar">NV</div>
                <div class="user-details">
                    <p><strong>Dra. Maria Oliveira</strong></p>
                    <p>Nutricionista CRN-12345</p>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <div class="container main-content">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>Menu Principal</h3>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="patients">
                        <i class="fas fa-users"></i> Pacientes
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="menus">
                        <i class="fas fa-utensils"></i> Cardápios
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="assessments">
                        <i class="fas fa-weight"></i> Avaliações
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="taco">
                        <i class="fas fa-database"></i> Tabela TACO
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="preparations">
                        <i class="fas fa-blender"></i> Preparos
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="reports">
                        <i class="fas fa-chart-bar"></i> Relatórios
                    </a>
                </li>
            </ul>
        </aside>
        
        <!-- Content Area -->
        <main class="content-area">
            <div id="page-content">
                <!-- Dashboard -->
                <div id="dashboard-page" class="page">
                    <div class="page-title">
                        <h2>Dashboard</h2>
                        <div class="btn-group">
                            <button class="btn" onclick="app.openModal('new-patient-modal')">
                                <i class="fas fa-user-plus"></i> Novo Paciente
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-cards">
                        <div class="card">
                            <i class="fas fa-users"></i>
                            <h3 id="total-patients">0</h3>
                            <p>Pacientes Ativos</p>
                        </div>
                        <div class="card">
                            <i class="fas fa-utensils"></i>
                            <h3 id="total-menus">0</h3>
                            <p>Cardápios Criados</p>
                        </div>
                        <div class="card">
                            <i class="fas fa-weight"></i>
                            <h3 id="total-assessments">0</h3>
                            <p>Avaliações Hoje</p>
                        </div>
                        <div class="card">
                            <i class="fas fa-calendar-check"></i>
                            <h3 id="followups-due">0</h3>
                            <p>Retornos Pendentes</p>
                        </div>
                    </div>
                    
                    <div class="export-section">
                        <h3 style="color: var(--accent-color); margin-bottom: 15px;">Ações Rápidas</h3>
                        <div class="export-buttons">
                            <button class="export-btn export-pdf" onclick="app.openModal('new-assessment-modal')">
                                <i class="fas fa-weight"></i>
                                <span>Nova Avaliação</span>
                            </button>
                            <button class="export-btn export-excel" onclick="app.openModal('new-menu-modal')">
                                <i class="fas fa-utensils"></i>
                                <span>Novo Cardápio</span>
                            </button>
                            <button class="export-btn" onclick="app.navigateTo('taco')">
                                <i class="fas fa-database"></i>
                                <span>Tabela TACO</span>
                            </button>
                            <button class="export-btn" onclick="app.navigateTo('reports')">
                                <i class="fas fa-chart-bar"></i>
                                <span>Relatórios</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Outras páginas -->
                <div id="patients-page" class="page" style="display: none;"></div>
                <div id="menus-page" class="page" style="display: none;"></div>
                <div id="assessments-page" class="page" style="display: none;"></div>
                <div id="taco-page" class="page" style="display: none;"></div>
                <div id="preparations-page" class="page" style="display: none;"></div>
                <div id="reports-page" class="page" style="display: none;"></div>
            </div>
        </main>
    </div>
    
    <!-- Footer -->
    <footer>
        <div class="container footer-content">
            <div class="footer-logo">
                <i class="fas fa-apple-alt"></i>
                <div>
                    <h3>NutriVision Pro</h3>
                    <p>Sistema completo de gestão nutricional</p>
                </div>
            </div>
            <div>
                <p>&copy; 2023 NutriVision Pro. Versão 3.0</p>
            </div>
        </div>
    </footer>
    
    <!-- Modais -->
    
    <!-- Modal Novo Paciente -->
    <div id="new-patient-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="app.closeModal('new-patient-modal')">&times;</span>
            <div class="modal-header">
                <h3>Cadastrar Novo Paciente</h3>
            </div>
            <form id="new-patient-form" onsubmit="app.savePatient(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="patient-name">Nome Completo *</label>
                        <input type="text" id="patient-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="patient-email">Email</label>
                        <input type="email" id="patient-email" class="form-control">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="patient-phone">Telefone *</label>
                        <input type="tel" id="patient-phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="patient-birthdate">Data de Nascimento *</label>
                        <input type="date" id="patient-birthdate" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="patient-gender">Sexo *</label>
                        <select id="patient-gender" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="M">Masculino</option>
                            <option value="F">Feminino</option>
                            <option value="O">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="patient-type">Tipo de Paciente *</label>
                        <select id="patient-type" class="form-control" required>
                            <option value="normal">Normal</option>
                            <option value="amputado">Amputado</option>
                            <option value="acamado">Acamado</option>
                            <option value="cadeirante">Cadeirante</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="patient-objective">Objetivo Principal</label>
                    <select id="patient-objective" class="form-control">
                        <option value="emagrecimento">Emagrecimento</option>
                        <option value="hipertrofia">Hipertrofia Muscular</option>
                        <option value="saude">Melhora da Saúde</option>
                        <option value="manutencao">Manutenção do Peso</option>
                        <option value="performance">Performance Esportiva</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="patient-notes">Observações</label>
                    <textarea id="patient-notes" class="form-control" rows="3" placeholder="Observações iniciais..."></textarea>
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 15px;">
                    <button type="submit" class="btn">Salvar Paciente</button>
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('new-patient-modal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Nova Avaliação -->
    <div id="new-assessment-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close-modal" onclick="app.closeModal('new-assessment-modal')">&times;</span>
            <div class="modal-header">
                <h3>Nova Avaliação Antropométrica</h3>
            </div>
            
            <div class="tabs">
                <button type="button" class="tab active" data-tab="basic">Dados Básicos</button>
                <button type="button" class="tab" data-tab="anthropometric">Medidas Antropométricas</button>
                <button type="button" class="tab" data-tab="adipometer">Adipômetro</button>
                <button type="button" class="tab" data-tab="results">Resultados</button>
            </div>
            
            <form id="new-assessment-form" onsubmit="app.saveAssessment(event)">
                <div class="tab-content active" id="tab-basic">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="assessment-patient">Paciente *</label>
                            <select id="assessment-patient" class="form-control" required>
                                <option value="">Selecione um paciente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="assessment-date">Data da Avaliação *</label>
                            <input type="date" id="assessment-date" class="form-control" required>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-anthropometric">
                    <div class="assessment-grid">
                        <div class="measurement-group">
                            <h4>Medidas Básicas</h4>
                            <div class="measurement-inputs">
                                <div class="measurement-input">
                                    <label>Peso (kg):</label>
                                    <input type="number" id="assessment-weight" step="0.1" min="20" max="300" required>
                                </div>
                                <div class="measurement-input">
                                    <label>Altura (cm):</label>
                                    <input type="number" id="assessment-height" step="0.1" min="50" max="250" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="measurement-group">
                            <h4>Circunferências (cm)</h4>
                            <div class="measurement-inputs">
                                <div class="measurement-input">
                                    <label>Cintura:</label>
                                    <input type="number" id="circ-waist" step="0.1">
                                </div>
                                <div class="measurement-input">
                                    <label>Abdominal:</label>
                                    <input type="number" id="circ-abdomen" step="0.1">
                                </div>
                                <div class="measurement-input">
                                    <label>Quadril:</label>
                                    <input type="number" id="circ-hip" step="0.1">
                                </div>
                                <div class="measurement-input">
                                    <label>Braço:</label>
                                    <input type="number" id="circ-arm" step="0.1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-adipometer">
                    <div class="assessment-grid">
                        <div class="measurement-group">
                            <h4>Medidas com Adipômetro (mm)</h4>
                            <div class="measurement-inputs">
                                <div class="measurement-input">
                                    <label>Tríceps:</label>
                                    <input type="number" id="adip-triceps" step="0.1" min="0" max="50">
                                </div>
                                <div class="measurement-input">
                                    <label>Subescapular:</label>
                                    <input type="number" id="adip-subescapular" step="0.1" min="0" max="50">
                                </div>
                                <div class="measurement-input">
                                    <label>Abdômen:</label>
                                    <input type="number" id="adip-abdomen" step="0.1" min="0" max="50">
                                </div>
                                <div class="measurement-input">
                                    <label>Coxa:</label>
                                    <input type="number" id="adip-coxa" step="0.1" min="0" max="50">
                                </div>
                                <div class="measurement-input">
                                    <label>Suprailíaca:</label>
                                    <input type="number" id="adip-suprailíaca" step="0.1" min="0" max="50">
                                </div>
                                <div class="measurement-input">
                                    <label>Peitoral:</label>
                                    <input type="number" id="adip-peitoral" step="0.1" min="0" max="50">
                                </div>
                                <div class="measurement-input">
                                    <label>Axilar Média:</label>
                                    <input type="number" id="adip-axilar" step="0.1" min="0" max="50">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-results">
                    <div class="measurement-group" style="margin-bottom: 25px;">
                        <h4>Resultados Calculados</h4>
                        <div id="assessment-results" style="padding: 15px; background: white; border-radius: 8px;">
                            <!-- Preenchido por JavaScript -->
                        </div>
                    </div>
                    
                    <div id="assessment-message"></div>
                    
                    <div class="form-group">
                        <label for="assessment-notes">Observações e Recomendações</label>
                        <textarea id="assessment-notes" class="form-control" rows="4" placeholder="Observações sobre a avaliação..."></textarea>
                    </div>
                    
                    <div class="export-buttons" style="margin-top: 30px;">
                        <button type="button" class="export-btn export-pdf" onclick="app.exportAssessmentPDF()">
                            <i class="fas fa-file-pdf"></i>
                            <span>Exportar PDF</span>
                        </button>
                        <button type="button" class="export-btn export-excel" onclick="app.exportAssessmentExcel()">
                            <i class="fas fa-file-excel"></i>
                            <span>Exportar Excel</span>
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 40px; display: flex; justify-content: space-between;">
                    <button type="button" class="btn btn-secondary" id="prev-tab-btn" onclick="app.prevTab()">← Anterior</button>
                    <div style="display: flex; gap: 15px;">
                        <button type="button" class="btn btn-secondary" id="next-tab-btn" onclick="app.nextTab()">Próximo →</button>
                        <button type="submit" class="btn">Salvar Avaliação</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Novo Cardápio -->
    <div id="new-menu-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <span class="close-modal" onclick="app.closeModal('new-menu-modal')">&times;</span>
            <div class="modal-header">
                <h3>Criar Novo Cardápio</h3>
            </div>
            
            <div class="tabs">
                <button type="button" class="tab active" data-tab="menu-info">Informações</button>
                <button type="button" class="tab" data-tab="menu-meals">Refeições</button>
                <button type="button" class="tab" data-tab="menu-taco">Alimentos TACO</button>
                <button type="button" class="tab" data-tab="menu-preparations">Preparos</button>
                <button type="button" class="tab" data-tab="menu-export">Exportação</button>
            </div>
            
            <form id="new-menu-form" onsubmit="app.saveMenu(event)">
                <div class="tab-content active" id="tab-menu-info">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="menu-patient">Paciente *</label>
                            <select id="menu-patient" class="form-control" required>
                                <option value="">Selecione um paciente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="menu-name">Nome do Cardápio *</label>
                            <input type="text" id="menu-name" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="menu-days">Duração (dias) *</label>
                            <input type="number" id="menu-days" class="form-control" min="1" max="30" value="7" required>
                        </div>
                        <div class="form-group">
                            <label for="menu-calories">Calorias Diárias *</label>
                            <input type="number" id="menu-calories" class="form-control" min="800" max="5000" value="1800" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="menu-description">Descrição</label>
                        <textarea id="menu-description" class="form-control" rows="3" placeholder="Descreva o objetivo deste cardápio..."></textarea>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-menu-meals">
                    <div id="meal-times-container">
                        <!-- Refeições serão adicionadas aqui -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="app.addMealTime()" style="margin-top: 20px;">
                        <i class="fas fa-plus"></i> Adicionar Refeição
                    </button>
                </div>
                
                <div class="tab-content" id="tab-menu-taco">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="taco-food-search" placeholder="Buscar alimentos na tabela TACO...">
                    </div>
                    
                    <div id="taco-food-results" style="margin-top: 20px; max-height: 300px; overflow-y: auto; border: 1px solid var(--light-gray); border-radius: var(--border-radius); padding: 15px;">
                        <!-- Resultados da busca -->
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">Alimentos Selecionados</h4>
                        <div id="selected-foods-container" style="min-height: 100px; padding: 20px; border: 2px dashed var(--light-gray); border-radius: var(--border-radius);">
                            <p style="color: var(--gray-color); text-align: center; margin: 20px 0;">Nenhum alimento selecionado</p>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button type="button" class="btn btn-small" onclick="app.addSelectedFoodsToMeal()">
                                <i class="fas fa-plus"></i> Adicionar à Refeição
                            </button>
                            <button type="button" class="btn btn-small btn-danger" onclick="app.clearSelectedFoods()">
                                <i class="fas fa-trash"></i> Limpar Seleção
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-menu-preparations">
                    <div class="form-group">
                        <label>Selecionar Preparo Pré-configurado</label>
                        <select id="menu-preparation-select" class="form-control" onchange="app.addPreparationToMenu(this.value)">
                            <option value="">Selecione um preparo...</option>
                        </select>
                    </div>
                    
                    <div id="menu-preparations-container" style="margin-top: 20px; min-height: 100px; padding: 20px; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                        <!-- Preparos serão adicionados aqui -->
                    </div>
                </div>
                
                <div class="tab-content" id="tab-menu-export">
                    <div class="export-section">
                        <h3 style="color: var(--accent-color); margin-bottom: 20px;">Exportar Cardápio</h3>
                        <p style="margin-bottom: 20px; color: var(--gray-color);">Gere relatórios do cardápio para impressão ou compartilhamento com o paciente.</p>
                        
                        <div class="export-buttons">
                            <button type="button" class="export-btn export-pdf" onclick="app.exportMenuPDF()">
                                <i class="fas fa-file-pdf"></i>
                                <div>
                                    <strong>PDF Detalhado</strong>
                                    <small style="display: block; font-weight: normal; opacity: 0.8;">Cardápio completo</small>
                                </div>
                            </button>
                            <button type="button" class="export-btn export-excel" onclick="app.exportMenuExcel()">
                                <i class="fas fa-file-excel"></i>
                                <div>
                                    <strong>Excel Nutricional</strong>
                                    <small style="display: block; font-weight: normal; opacity: 0.8;">Com valores nutricionais</small>
                                </div>
                            </button>
                            <button type="button" class="export-btn" onclick="app.exportMenuShoppingList()">
                                <i class="fas fa-shopping-cart"></i>
                                <div>
                                    <strong>Lista de Compras</strong>
                                    <small style="display: block; font-weight: normal; opacity: 0.8;">Para o paciente</small>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 40px; display: flex; gap: 15px;">
                    <button type="submit" class="btn">Salvar Cardápio</button>
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('new-menu-modal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Gerenciar Tabela TACO -->
    <div id="taco-management-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <span class="close-modal" onclick="app.closeModal('taco-management-modal')">&times;</span>
            <div class="modal-header">
                <h3>Gerenciar Tabela TACO</h3>
            </div>
            
            <div class="taco-actions">
                <div class="search-container" style="flex: 1;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="taco-management-search" placeholder="Buscar alimentos...">
                </div>
                <button class="btn" onclick="app.openAddFoodModal()">
                    <i class="fas fa-plus"></i> Adicionar Alimento
                </button>
                <button class="btn btn-secondary" onclick="app.exportTACOToExcel()">
                    <i class="fas fa-file-excel"></i> Exportar Excel
                </button>
                <button class="btn btn-accent" onclick="app.importTACOData()">
                    <i class="fas fa-file-import"></i> Importar
                </button>
            </div>
            
            <div class="table-container" style="margin-top: 20px;">
                <table id="taco-management-table">
                    <thead>
                        <tr>
                            <th>Alimento</th>
                            <th>Categoria</th>
                            <th>Calorias</th>
                            <th>Proteínas</th>
                            <th>Carboidratos</th>
                            <th>Gorduras</th>
                            <th>Medida Caseira</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Preenchido por JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal Adicionar Alimento TACO -->
    <div id="add-food-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-modal" onclick="app.closeModal('add-food-modal')">&times;</span>
            <div class="modal-header">
                <h3>Adicionar Novo Alimento</h3>
            </div>
            
            <form id="add-food-form" onsubmit="app.saveFood(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="food-name">Nome do Alimento *</label>
                        <input type="text" id="food-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="food-category">Categoria *</label>
                        <select id="food-category" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="Cereais e derivados">Cereais e derivados</option>
                            <option value="Frutas">Frutas</option>
                            <option value="Hortaliças">Hortaliças</option>
                            <option value="Leguminosas">Leguminosas</option>
                            <option value="Carnes e derivados">Carnes e derivados</option>
                            <option value="Leite e derivados">Leite e derivados</option>
                            <option value="Óleos e gorduras">Óleos e gorduras</option>
                            <option value="Açúcares e doces">Açúcares e doces</option>
                            <option value="Bebidas">Bebidas</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="food-calories">Calorias (kcal) *</label>
                        <input type="number" id="food-calories" class="form-control" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="food-protein">Proteínas (g)</label>
                        <input type="number" id="food-protein" class="form-control" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="food-carbs">Carboidratos (g)</label>
                        <input type="number" id="food-carbs" class="form-control" step="0.1">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="food-fat">Gorduras (g)</label>
                        <input type="number" id="food-fat" class="form-control" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="food-fiber">Fibras (g)</label>
                        <input type="number" id="food-fiber" class="form-control" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="food-sodium">Sódio (mg)</label>
                        <input type="number" id="food-sodium" class="form-control" step="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="food-home-measure">Medida Caseira *</label>
                    <input type="text" id="food-home-measure" class="form-control" placeholder="Ex: 1 colher de sopa (15g)" required>
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 15px;">
                    <button type="submit" class="btn">Salvar Alimento</button>
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('add-food-modal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // NUTRIVISION PRO - SISTEMA COMPLETO
        // Versão 3.0 - Todas as funcionalidades funcionando
        // ============================================
        
        class NutriVision {
            constructor() {
                this.currentTab = 'basic';
                this.selectedFoods = [];
                this.initDatabase();
                this.initApp();
            }
            
            initDatabase() {
                if (!localStorage.getItem('nutrivision_initialized')) {
                    const initialData = {
                        patients: [],
                        assessments: [],
                        menus: [],
                        foods: this.getCompleteTACOFoods(),
                        preparations: this.getDefaultPreparations(),
                        settings: {
                            exportFormat: 'pdf',
                            theme: 'default'
                        }
                    };
                    
                    localStorage.setItem('nutrivision_data', JSON.stringify(initialData));
                    localStorage.setItem('nutrivision_initialized', 'true');
                }
            }
            
            getCompleteTACOFoods() {
                return [
                    // Cereais e derivados
                    { id: 1, name: "Arroz branco, cozido", category: "Cereais e derivados", calories: 128, protein: 2.5, carbs: 28.1, fat: 0.2, fiber: 0.6, sodium: 1, homeMeasure: "4 colheres de sopa (100g)" },
                    { id: 2, name: "Arroz integral, cozido", category: "Cereais e derivados", calories: 124, protein: 2.6, carbs: 25.8, fat: 1.0, fiber: 2.7, sodium: 1, homeMeasure: "4 colheres de sopa (100g)" },
                    { id: 3, name: "Macarrão, cozido", category: "Cereais e derivados", calories: 159, protein: 5.8, carbs: 32.5, fat: 0.6, fiber: 1.5, sodium: 2, homeMeasure: "4 colheres de sopa (100g)" },
                    { id: 4, name: "Pão francês", category: "Cereais e derivados", calories: 300, protein: 8.0, carbs: 58.6, fat: 3.1, fiber: 2.3, sodium: 648, homeMeasure: "1 unidade (50g)" },
                    { id: 5, name: "Pão de forma integral", category: "Cereais e derivados", calories: 253, protein: 12.4, carbs: 44.8, fat: 3.6, fiber: 6.9, sodium: 400, homeMeasure: "2 fatias (50g)" },
                    
                    // Frutas
                    { id: 6, name: "Banana prata", category: "Frutas", calories: 89, protein: 1.1, carbs: 22.8, fat: 0.3, fiber: 2.6, sodium: 0, homeMeasure: "1 unidade média (50g)" },
                    { id: 7, name: "Maçã", category: "Frutas", calories: 56, protein: 0.3, carbs: 15.2, fat: 0.2, fiber: 1.3, sodium: 1, homeMeasure: "1 unidade média (130g)" },
                    { id: 8, name: "Laranja pera", category: "Frutas", calories: 37, protein: 1.0, carbs: 8.9, fat: 0.1, fiber: 0.8, sodium: 1, homeMeasure: "1 unidade média (130g)" },
                    { id: 9, name: "Mamão formosa", category: "Frutas", calories: 45, protein: 0.8, carbs: 11.6, fat: 0.1, fiber: 1.8, sodium: 8, homeMeasure: "1 fatia média (100g)" },
                    { id: 10, name: "Melancia", category: "Frutas", calories: 33, protein: 0.9, carbs: 8.1, fat: 0.0, fiber: 0.1, sodium: 0, homeMeasure: "1 fatia média (100g)" },
                    
                    // Hortaliças
                    { id: 11, name: "Alface crespa", category: "Hortaliças", calories: 11, protein: 1.3, carbs: 1.7, fat: 0.2, fiber: 2.0, sodium: 4, homeMeasure: "5 folhas (30g)" },
                    { id: 12, name: "Tomate", category: "Hortaliças", calories: 15, protein: 1.1, carbs: 3.1, fat: 0.2, fiber: 1.2, sodium: 1, homeMeasure: "1 unidade média (100g)" },
                    { id: 13, name: "Cenoura crua", category: "Hortaliças", calories: 34, protein: 1.3, carbs: 7.7, fat: 0.2, fiber: 2.6, sodium: 3, homeMeasure: "1 unidade média (60g)" },
                    { id: 14, name: "Batata inglesa, cozida", category: "Hortaliças", calories: 52, protein: 1.2, carbs: 11.9, fat: 0.0, fiber: 1.3, sodium: 1, homeMeasure: "1 unidade média (100g)" },
                    { id: 15, name: "Brócolis, cozido", category: "Hortaliças", calories: 25, protein: 2.1, carbs: 4.4, fat: 0.3, fiber: 3.4, sodium: 8, homeMeasure: "4 colheres de sopa (100g)" },
                    
                    // Leguminosas
                    { id: 16, name: "Feijão carioca, cozido", category: "Leguminosas", calories: 76, protein: 4.8, carbs: 13.6, fat: 0.5, fiber: 5.1, sodium: 1, homeMeasure: "1 concha média (100g)" },
                    { id: 17, name: "Lentilha, cozida", category: "Leguminosas", calories: 93, protein: 6.3, carbs: 16.3, fat: 0.5, fiber: 7.9, sodium: 1, homeMeasure: "1 concha (100g)" },
                    { id: 18, name: "Grão-de-bico, cozido", category: "Leguminosas", calories: 120, protein: 8.0, carbs: 19.0, fat: 2.0, fiber: 7.6, sodium: 5, homeMeasure: "1 concha (100g)" },
                    
                    // Carnes e derivados
                    { id: 19, name: "Frango, peito, grelhado", category: "Carnes e derivados", calories: 159, protein: 32.0, carbs: 0.0, fat: 2.5, fiber: 0.0, sodium: 45, homeMeasure: "1 filé médio (100g)" },
                    { id: 20, name: "Carne bovina, patinho, grelhado", category: "Carnes e derivados", calories: 219, protein: 35.9, carbs: 0.0, fat: 7.0, fiber: 0.0, sodium: 62, homeMeasure: "1 bife médio (100g)" },
                    { id: 21, name: "Peixe, pescada, cozido", category: "Carnes e derivados", calories: 109, protein: 23.4, carbs: 0.0, fat: 1.2, fiber: 0.0, sodium: 101, homeMeasure: "1 filé médio (100g)" },
                    { id: 22, name: "Ovo de galinha, cozido", category: "Carnes e derivados", calories: 146, protein: 13.3, carbs: 0.6, fat: 9.5, fiber: 0.0, sodium: 140, homeMeasure: "1 unidade (50g)" },
                    
                    // Leite e derivados
                    { id: 23, name: "Leite integral", category: "Leite e derivados", calories: 61, protein: 3.1, carbs: 4.8, fat: 3.3, fiber: 0.0, sodium: 47, homeMeasure: "1 copo (200ml)" },
                    { id: 24, name: "Queijo minas frescal", category: "Leite e derivados", calories: 264, protein: 17.4, carbs: 3.2, fat: 20.2, fiber: 0.0, sodium: 340, homeMeasure: "1 fatia (30g)" },
                    { id: 25, name: "Iogurte natural", category: "Leite e derivados", calories: 51, protein: 4.1, carbs: 1.9, fat: 3.0, fiber: 0.0, sodium: 47, homeMeasure: "1 pote (170g)" },
                    
                    // Óleos e gorduras
                    { id: 26, name: "Óleo de soja", category: "Óleos e gorduras", calories: 884, protein: 0.0, carbs: 0.0, fat: 100.0, fiber: 0.0, sodium: 0, homeMeasure: "1 colher de sopa (10g)" },
                    { id: 27, name: "Azeite de oliva", category: "Óleos e gorduras", calories: 884, protein: 0.0, carbs: 0.0, fat: 100.0, fiber: 0.0, sodium: 0, homeMeasure: "1 colher de sopa (10g)" },
                    { id: 28, name: "Margarina", category: "Óleos e gorduras", calories: 720, protein: 0.2, carbs: 0.6, fat: 81.0, fiber: 0.0, sodium: 980, homeMeasure: "1 colher de chá (5g)" },
                    
                    // Açúcares e doces
                    { id: 29, name: "Açúcar cristal", category: "Açúcares e doces", calories: 387, protein: 0.3, carbs: 99.6, fat: 0.0, fiber: 0.0, sodium: 1, homeMeasure: "1 colher de sopa (10g)" },
                    { id: 30, name: "Mel", category: "Açúcares e doces", calories: 309, protein: 0.3, carbs: 84.0, fat: 0.0, fiber: 0.2, sodium: 7, homeMeasure: "1 colher de sopa (15g)" }
                ];
            }
            
            getDefaultPreparations() {
                return [
                    {
                        id: 1,
                        name: "Smoothie Proteico Matinal",
                        description: "Bebida nutritiva para café da manhã rica em proteínas",
                        category: "Bebidas",
                        calories: 320,
                        protein: 25,
                        carbs: 35,
                        fat: 8,
                        ingredients: [
                            { name: "Leite integral", quantity: "200ml" },
                            { name: "Iogurte natural", quantity: "1 pote" },
                            { name: "Banana", quantity: "1 unidade" },
                            { name: "Aveia em flocos", quantity: "2 colheres" },
                            { name: "Mel", quantity: "1 colher" }
                        ],
                        instructions: "Bater todos os ingredientes no liquidificador por 2 minutos. Servir imediatamente."
                    },
                    {
                        id: 2,
                        name: "Salada Completa Light",
                        description: "Salada nutritiva e balanceada para o almoço",
                        category: "Saladas",
                        calories: 280,
                        protein: 22,
                        carbs: 18,
                        fat: 12,
                        ingredients: [
                            { name: "Alface crespa", quantity: "10 folhas" },
                            { name: "Tomate", quantity: "1 unidade" },
                            { name: "Cenoura crua", quantity: "1/2 unidade" },
                            { name: "Peito de frango grelhado", quantity: "100g" },
                            { name: "Azeite de oliva", quantity: "1 colher" },
                            { name: "Limão", quantity: "1/2 unidade" }
                        ],
                        instructions: "Lavar bem as folhas, cortar os vegetais em cubos. Grelhar o frango e desfiar. Misturar tudo e temperar com azeite e limão."
                    },
                    {
                        id: 3,
                        name: "Sopa de Legumes Cremosa",
                        description: "Sopa nutritiva para o jantar",
                        category: "Sopas",
                        calories: 180,
                        protein: 8,
                        carbs: 25,
                        fat: 5,
                        ingredients: [
                            { name: "Batata inglesa", quantity: "2 unidades" },
                            { name: "Cenoura", quantity: "1 unidade" },
                            { name: "Abóbora", quantity: "200g" },
                            { name: "Cebola", quantity: "1/2 unidade" },
                            { name: "Alho", quantity: "2 dentes" },
                            { name: "Azeite de oliva", quantity: "1 colher" }
                        ],
                        instructions: "Cozinhar todos os legumes até ficarem macios. Bater no liquidificador até obter creme. Acrescentar temperos a gosto."
                    }
                ];
            }
            
            getData() {
                const data = localStorage.getItem('nutrivision_data');
                return data ? JSON.parse(data) : {
                    patients: [],
                    assessments: [],
                    menus: [],
                    foods: [],
                    preparations: [],
                    settings: {}
                };
            }
            
            saveData(data) {
                localStorage.setItem('nutrivision_data', JSON.stringify(data));
            }
            
            initApp() {
                this.setupNavigation();
                this.setupTabs();
                this.setupModals();
                this.loadDashboard();
            }
            
            setupNavigation() {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        this.loadPage(link.dataset.page);
                    });
                });
            }
            
            setupTabs() {
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab')) {
                        const tabId = e.target.dataset.tab;
                        this.switchTab(tabId);
                    }
                });
            }
            
            setupModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });
            }
            
            switchTab(tabId) {
                // Atualizar tabs visíveis
                const container = document.querySelector('.modal-content');
                if (container) {
                    container.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.remove('active');
                        if (tab.dataset.tab === tabId) {
                            tab.classList.add('active');
                        }
                    });
                    
                    container.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `tab-${tabId}`) {
                            content.classList.add('active');
                        }
                    });
                }
                
                // Executar ações específicas por tab
                if (tabId === 'results') {
                    this.calculateAssessmentResults();
                } else if (tabId === 'menu-taco') {
                    this.loadTACOFoodSearch();
                }
                
                this.currentTab = tabId;
            }
            
            nextTab() {
                const tabs = ['basic', 'anthropometric', 'adipometer', 'results'];
                const currentIndex = tabs.indexOf(this.currentTab);
                if (currentIndex < tabs.length - 1) {
                    this.switchTab(tabs[currentIndex + 1]);
                }
            }
            
            prevTab() {
                const tabs = ['basic', 'anthropometric', 'adipometer', 'results'];
                const currentIndex = tabs.indexOf(this.currentTab);
                if (currentIndex > 0) {
                    this.switchTab(tabs[currentIndex - 1]);
                }
            }
            
            loadPage(page) {
                // Esconder todas as páginas
                document.querySelectorAll('.page').forEach(p => {
                    p.style.display = 'none';
                });
                
                // Mostrar página solicitada
                document.getElementById(`${page}-page`).style.display = 'block';
                
                // Carregar conteúdo específico
                switch(page) {
                    case 'dashboard':
                        this.loadDashboard();
                        break;
                    case 'patients':
                        this.loadPatientsPage();
                        break;
                    case 'menus':
                        this.loadMenusPage();
                        break;
                    case 'assessments':
                        this.loadAssessmentsPage();
                        break;
                    case 'taco':
                        this.loadTACOPage();
                        break;
                    case 'preparations':
                        this.loadPreparationsPage();
                        break;
                    case 'reports':
                        this.loadReportsPage();
                        break;
                }
            }
            
            loadDashboard() {
                const data = this.getData();
                
                // Atualizar estatísticas
                document.getElementById('total-patients').textContent = data.patients.length;
                document.getElementById('total-menus').textContent = data.menus.length;
                document.getElementById('total-assessments').textContent = data.assessments.length;
                
                // Calcular retornos pendentes (última avaliação há mais de 30 dias)
                const today = new Date();
                const dueFollowups = data.patients.filter(patient => {
                    const patientAssessments = data.assessments.filter(a => a.patientId === patient.id);
                    if (patientAssessments.length === 0) return false;
                    
                    const lastAssessment = patientAssessments.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    const lastDate = new Date(lastAssessment.date);
                    const daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                    
                    return daysDiff > 30;
                }).length;
                
                document.getElementById('followups-due').textContent = dueFollowups;
            }
            
            // ============================================
            // FUNÇÕES DE PACIENTES
            // ============================================
            
            loadPatientsPage() {
                const data = this.getData();
                
                let html = `
                    <div class="page-title">
                        <h2>Pacientes</h2>
                        <div>
                            <button class="btn" onclick="app.openModal('new-patient-modal')">
                                <i class="fas fa-user-plus"></i> Novo Paciente
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>Idade</th>
                                    <th>Última Avaliação</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.patients.forEach(patient => {
                    const age = this.calculateAge(patient.birthdate);
                    const patientAssessments = data.assessments.filter(a => a.patientId === patient.id);
                    const lastAssessment = patientAssessments.length > 0 
                        ? new Date(patientAssessments.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date).toLocaleDateString()
                        : 'Nenhuma';
                    
                    html += `
                        <tr>
                            <td><strong>${patient.name}</strong></td>
                            <td>${patient.phone}</td>
                            <td>${age} anos</td>
                            <td>${lastAssessment}</td>
                            <td><span class="badge badge-success">Ativo</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-small" onclick="app.viewPatient(${patient.id})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-small btn-accent" onclick="app.openAssessmentForPatient(${patient.id})">
                                        <i class="fas fa-weight"></i>
                                    </button>
                                    <button class="btn btn-small btn-secondary" onclick="app.openMenuForPatient(${patient.id})">
                                        <i class="fas fa-utensils"></i>
                                    </button>
                                    <button class="btn btn-small" onclick="app.exportPatientReport(${patient.id})">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                if (data.patients.length === 0) {
                    html += `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-color);">
                                <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                                <h3>Nenhum paciente cadastrado</h3>
                                <p>Clique em "Novo Paciente" para começar</p>
                            </td>
                        </tr>
                    `;
                }
                
                html += `</tbody></table></div>`;
                
                document.getElementById('patients-page').innerHTML = html;
            }
            
            calculateAge(birthdate) {
                const today = new Date();
                const birthDate = new Date(birthdate);
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                return age;
            }
            
            openModal(modalId, callback) {
                const modal = document.getElementById(modalId);
                modal.style.display = 'flex';
                
                // Resetar formulários
                const form = modal.querySelector('form');
                if (form) form.reset();
                
                // Configurações específicas por modal
                switch(modalId) {
                    case 'new-patient-modal':
                        const today = new Date().toISOString().split('T')[0];
                        document.getElementById('patient-birthdate').max = today;
                        break;
                        
                    case 'new-assessment-modal':
                        this.populatePatientSelect('assessment-patient');
                        document.getElementById('assessment-date').value = today;
                        this.switchTab('basic');
                        break;
                        
                    case 'new-menu-modal':
                        this.populatePatientSelect('menu-patient');
                        this.loadTACOFoodSearch();
                        this.populatePreparationsSelect();
                        this.switchTab('menu-info');
                        break;
                        
                    case 'taco-management-modal':
                        this.loadTacoManagementTable();
                        break;
                }
                
                if (callback) callback();
            }
            
            closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }
            
            populatePatientSelect(selectId) {
                const data = this.getData();
                const select = document.getElementById(selectId);
                
                if (!select) return;
                
                select.innerHTML = '<option value="">Selecione um paciente</option>';
                data.patients.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.id;
                    option.textContent = patient.name;
                    select.appendChild(option);
                });
            }
            
            savePatient(event) {
                event.preventDefault();
                
                const data = this.getData();
                const newId = data.patients.length > 0 ? Math.max(...data.patients.map(p => p.id)) + 1 : 1;
                
                const patient = {
                    id: newId,
                    name: document.getElementById('patient-name').value,
                    email: document.getElementById('patient-email').value,
                    phone: document.getElementById('patient-phone').value,
                    birthdate: document.getElementById('patient-birthdate').value,
                    gender: document.getElementById('patient-gender').value,
                    type: document.getElementById('patient-type').value,
                    objective: document.getElementById('patient-objective').value,
                    notes: document.getElementById('patient-notes').value,
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                
                data.patients.push(patient);
                this.saveData(data);
                
                this.showMessage('success', 'Paciente cadastrado com sucesso!');
                this.closeModal('new-patient-modal');
                this.loadPatientsPage();
                this.loadDashboard();
            }
            
            // ============================================
            // FUNÇÕES DE AVALIAÇÕES
            // ============================================
            
            loadAssessmentsPage() {
                const data = this.getData();
                
                let html = `
                    <div class="page-title">
                        <h2>Avaliações Antropométricas</h2>
                        <div>
                            <button class="btn btn-accent" onclick="app.openModal('new-assessment-modal')">
                                <i class="fas fa-plus"></i> Nova Avaliação
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Paciente</th>
                                    <th>Peso (kg)</th>
                                    <th>Altura (cm)</th>
                                    <th>IMC</th>
                                    <th>Exportar</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.assessments.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(assessment => {
                    const patient = data.patients.find(p => p.id === assessment.patientId);
                    const imc = this.calculateIMC(assessment.weight, assessment.height);
                    
                    html += `
                        <tr>
                            <td>${new Date(assessment.date).toLocaleDateString()}</td>
                            <td>${patient ? patient.name : 'Paciente não encontrado'}</td>
                            <td>${assessment.weight}</td>
                            <td>${assessment.height}</td>
                            <td>
                                ${imc.imc}
                                <span class="imc-indicator ${imc.colorClass}">${imc.classification}</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-small" onclick="app.exportAssessmentPDF(${assessment.id})">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                    <button class="btn btn-small" onclick="app.exportAssessmentExcel(${assessment.id})">
                                        <i class="fas fa-file-excel"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                if (data.assessments.length === 0) {
                    html += `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-color);">
                                <i class="fas fa-weight" style="font-size: 3rem; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                                <h3>Nenhuma avaliação realizada</h3>
                                <p>Clique em "Nova Avaliação" para começar</p>
                            </td>
                        </tr>
                    `;
                }
                
                html += `</tbody></table></div>`;
                
                document.getElementById('assessments-page').innerHTML = html;
            }
            
            calculateIMC(weight, height) {
                const heightM = height / 100;
                const imc = (weight / (heightM * heightM)).toFixed(1);
                
                let classification = "";
                let colorClass = "";
                
                if (imc < 18.5) {
                    classification = "Abaixo do peso";
                    colorClass = "imc-abaixo";
                } else if (imc < 24.9) {
                    classification = "Peso normal";
                    colorClass = "imc-eutrofico";
                } else if (imc < 29.9) {
                    classification = "Sobrepeso";
                    colorClass = "imc-sobrepeso";
                } else {
                    classification = "Obesidade";
                    colorClass = "imc-obesidade";
                }
                
                return { imc, classification, colorClass };
            }
            
            calculateAssessmentResults() {
                const weight = parseFloat(document.getElementById('assessment-weight').value) || 0;
                const height = parseFloat(document.getElementById('assessment-height').value) || 0;
                
                let resultsHTML = '';
                
                if (weight > 0 && height > 0) {
                    const imc = this.calculateIMC(weight, height);
                    resultsHTML += `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                                <div style="font-size: 0.9rem; color: var(--gray-color);">IMC</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-color);">${imc.imc} kg/m²</div>
                                <span class="imc-indicator ${imc.colorClass}">${imc.classification}</span>
                            </div>
                    `;
                    
                    // Calcular peso ideal (IMC 22)
                    const idealWeight = (22 * (height/100) ** 2).toFixed(1);
                    resultsHTML += `
                            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid var(--secondary-color);">
                                <div style="font-size: 0.9rem; color: var(--gray-color);">Peso Ideal</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-color);">${idealWeight} kg</div>
                                <div style="font-size: 0.9rem; color: var(--gray-color);">para IMC 22</div>
                            </div>
                    `;
                    
                    // Calcular variação para peso ideal
                    const weightDiff = (weight - idealWeight).toFixed(1);
                    resultsHTML += `
                            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid var(--info-color);">
                                <div style="font-size: 0.9rem; color: var(--gray-color);">Variação</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: ${weightDiff > 0 ? 'var(--danger-color)' : 'var(--success-color)'};">${Math.abs(weightDiff)} kg</div>
                                <div style="font-size: 0.9rem; color: var(--gray-color);">${weightDiff > 0 ? 'Acima do ideal' : 'Abaixo do ideal'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    resultsHTML = '<p style="color: var(--gray-color); text-align: center;">Preencha peso e altura para calcular os resultados</p>';
                }
                
                document.getElementById('assessment-results').innerHTML = resultsHTML;
            }
            
            saveAssessment(event) {
                event.preventDefault();
                
                const data = this.getData();
                const newId = data.assessments.length > 0 ? Math.max(...data.assessments.map(a => a.id)) + 1 : 1;
                
                const assessment = {
                    id: newId,
                    patientId: parseInt(document.getElementById('assessment-patient').value),
                    date: document.getElementById('assessment-date').value,
                    weight: parseFloat(document.getElementById('assessment-weight').value),
                    height: parseFloat(document.getElementById('assessment-height').value),
                    waist: document.getElementById('circ-waist').value ? parseFloat(document.getElementById('circ-waist').value) : null,
                    abdomen: document.getElementById('circ-abdomen').value ? parseFloat(document.getElementById('circ-abdomen').value) : null,
                    hip: document.getElementById('circ-hip').value ? parseFloat(document.getElementById('circ-hip').value) : null,
                    arm: document.getElementById('circ-arm').value ? parseFloat(document.getElementById('circ-arm').value) : null,
                    triceps: document.getElementById('adip-triceps').value ? parseFloat(document.getElementById('adip-triceps').value) : null,
                    subscapular: document.getElementById('adip-subescapular').value ? parseFloat(document.getElementById('adip-subescapular').value) : null,
                    abdomenAdip: document.getElementById('adip-abdomen').value ? parseFloat(document.getElementById('adip-abdomen').value) : null,
                    thigh: document.getElementById('adip-coxa').value ? parseFloat(document.getElementById('adip-coxa').value) : null,
                    suprailiac: document.getElementById('adip-suprailíaca').value ? parseFloat(document.getElementById('adip-suprailíaca').value) : null,
                    chest: document.getElementById('adip-peitoral').value ? parseFloat(document.getElementById('adip-peitoral').value) : null,
                    axilla: document.getElementById('adip-axilar').value ? parseFloat(document.getElementById('adip-axilar').value) : null,
                    notes: document.getElementById('assessment-notes').value,
                    createdAt: new Date().toISOString()
                };
                
                data.assessments.push(assessment);
                this.saveData(data);
                
                this.showMessage('success', 'Avaliação salva com sucesso!');
                this.closeModal('new-assessment-modal');
                this.loadAssessmentsPage();
                this.loadDashboard();
            }
            
            // ============================================
            // FUNÇÕES DE CARDÁPIOS
            // ============================================
            
            loadMenusPage() {
                const data = this.getData();
                
                let html = `
                    <div class="page-title">
                        <h2>Cardápios</h2>
                        <div>
                            <button class="btn" onclick="app.openModal('new-menu-modal')">
                                <i class="fas fa-plus"></i> Novo Cardápio
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; margin-top: 20px;">
                `;
                
                data.menus.forEach(menu => {
                    const patient = data.patients.find(p => p.id === menu.patientId);
                    
                    html += `
                        <div class="preparation-card">
                            <div class="preparation-header">
                                <div class="preparation-name">${menu.name}</div>
                                <div class="preparation-category">${menu.days} dias</div>
                            </div>
                            <div class="preparation-description">
                                <p><strong>Paciente:</strong> ${patient ? patient.name : 'Não informado'}</p>
                                <p><strong>Calorias diárias:</strong> ${menu.calories} kcal</p>
                                ${menu.description ? `<p>${menu.description}</p>` : ''}
                            </div>
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn btn-small" onclick="app.viewMenu(${menu.id})">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                                <button class="btn btn-small btn-accent" onclick="app.exportMenuPDF(${menu.id})">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="btn btn-small btn-secondary" onclick="app.exportMenuExcel(${menu.id})">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                if (data.menus.length === 0) {
                    html += `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--gray-color);">
                            <i class="fas fa-utensils" style="font-size: 4rem; margin-bottom: 20px; display: block; opacity: 0.5;"></i>
                            <h3>Nenhum cardápio criado</h3>
                            <p>Clique em "Novo Cardápio" para começar</p>
                        </div>
                    `;
                }
                
                html += `</div>`;
                
                document.getElementById('menus-page').innerHTML = html;
            }
            
            addMealTime() {
                const container = document.getElementById('meal-times-container');
                const mealCount = container.querySelectorAll('.meal-time-group').length + 1;
                const mealTimes = ["Café da manhã", "Lanche da manhã", "Almoço", "Lanche da tarde", "Jantar", "Ceia"];
                
                const mealTime = mealTimes[mealCount - 1] || `Refeição ${mealCount}`;
                
                const mealGroup = document.createElement('div');
                mealGroup.className = 'meal-time-group';
                mealGroup.innerHTML = `
                    <div style="background: white; border-radius: var(--border-radius); padding: 20px; margin-bottom: 15px; border: 1px solid var(--light-gray);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: var(--primary-color); margin: 0;">${mealTime}</h4>
                            <button type="button" class="btn btn-small btn-danger" onclick="this.parentElement.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="meal-items-container">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" class="form-control meal-item-input" placeholder="Ex: 2 ovos mexidos">
                                <button type="button" class="btn btn-small btn-danger" onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-small" onclick="this.previousElementSibling.appendChild(this.createMealItemInput())" style="margin-top: 10px;">
                            <i class="fas fa-plus"></i> Adicionar Item
                        </button>
                    </div>
                `;
                
                container.appendChild(mealGroup);
            }
            
            createMealItemInput() {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
                div.innerHTML = `
                    <input type="text" class="form-control meal-item-input" placeholder="Ex: 1 fatia de pão integral">
                    <button type="button" class="btn btn-small btn-danger" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                return div;
            }
            
            loadTACOFoodSearch() {
                const searchInput = document.getElementById('taco-food-search');
                const resultsContainer = document.getElementById('taco-food-results');
                
                if (!searchInput || !resultsContainer) return;
                
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const data = this.getData();
                    
                    if (query.length < 2) {
                        resultsContainer.innerHTML = '<p style="color: var(--gray-color); text-align: center; padding: 20px;">Digite pelo menos 2 caracteres para buscar</p>';
                        return;
                    }
                    
                    const filtered = data.foods.filter(food => 
                        food.name.toLowerCase().includes(query) ||
                        food.category.toLowerCase().includes(query)
                    );
                    
                    if (filtered.length === 0) {
                        resultsContainer.innerHTML = '<p style="color: var(--gray-color); text-align: center; padding: 20px;">Nenhum alimento encontrado</p>';
                        return;
                    }
                    
                    let resultsHTML = '<div style="display: grid; gap: 10px;">';
                    filtered.forEach(food => {
                        resultsHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; border: 1px solid var(--light-gray); cursor: pointer;" 
                                 onclick="app.selectFoodForMenu(${food.id})">
                                <div>
                                    <strong>${food.name}</strong>
                                    <div style="font-size: 0.9rem; color: var(--gray-color);">${food.category}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: var(--primary-color);">${food.calories} kcal</div>
                                    <div style="font-size: 0.9rem; color: var(--gray-color);">${food.homeMeasure}</div>
                                </div>
                            </div>
                        `;
                    });
                    resultsHTML += '</div>';
                    
                    resultsContainer.innerHTML = resultsHTML;
                });
            }
            
            selectFoodForMenu(foodId) {
                const data = this.getData();
                const food = data.foods.find(f => f.id === foodId);
                
                if (!food) return;
                
                // Verificar se já foi selecionado
                if (this.selectedFoods.find(f => f.id === foodId)) {
                    this.showMessage('info', 'Alimento já selecionado');
                    return;
                }
                
                this.selectedFoods.push(food);
                this.updateSelectedFoodsDisplay();
                this.showMessage('success', `${food.name} adicionado à seleção`);
            }
            
            updateSelectedFoodsDisplay() {
                const container = document.getElementById('selected-foods-container');
                
                if (this.selectedFoods.length === 0) {
                    container.innerHTML = '<p style="color: var(--gray-color); text-align: center; margin: 20px 0;">Nenhum alimento selecionado</p>';
                    return;
                }
                
                let html = '<div style="display: grid; gap: 10px;">';
                this.selectedFoods.forEach((food, index) => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; border: 1px solid var(--light-gray);">
                            <div>
                                <strong>${food.name}</strong>
                                <div style="font-size: 0.9rem; color: var(--gray-color);">${food.homeMeasure}</div>
                            </div>
                            <div>
                                <span style="font-weight: bold; color: var(--primary-color); margin-right: 15px;">${food.calories} kcal</span>
                                <button class="btn btn-small btn-danger" onclick="app.removeSelectedFood(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            }
            
            removeSelectedFood(index) {
                this.selectedFoods.splice(index, 1);
                this.updateSelectedFoodsDisplay();
            }
            
            addSelectedFoodsToMeal() {
                if (this.selectedFoods.length === 0) {
                    this.showMessage('info', 'Selecione alimentos primeiro');
                    return;
                }
                
                // Adicionar ao último grupo de refeição
                const mealGroups = document.querySelectorAll('#meal-times-container .meal-time-group');
                if (mealGroups.length === 0) {
                    this.addMealTime();
                }
                
                const lastMealGroup = document.querySelector('#meal-times-container .meal-time-group:last-child');
                const itemsContainer = lastMealGroup.querySelector('.meal-items-container');
                
                this.selectedFoods.forEach(food => {
                    const itemDiv = document.createElement('div');
                    itemDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
                    itemDiv.innerHTML = `
                        <input type="text" class="form-control meal-item-input" value="${food.name} - ${food.homeMeasure}" readonly>
                        <button type="button" class="btn btn-small btn-danger" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    itemsContainer.appendChild(itemDiv);
                });
                
                this.selectedFoods = [];
                this.updateSelectedFoodsDisplay();
                this.showMessage('success', 'Alimentos adicionados à refeição');
            }
            
            clearSelectedFoods() {
                this.selectedFoods = [];
                this.updateSelectedFoodsDisplay();
            }
            
            populatePreparationsSelect() {
                const data = this.getData();
                const select = document.getElementById('menu-preparation-select');
                
                if (!select) return;
                
                select.innerHTML = '<option value="">Selecione um preparo...</option>';
                data.preparations.forEach(prep => {
                    const option = document.createElement('option');
                    option.value = prep.id;
                    option.textContent = `${prep.name} (${prep.category})`;
                    select.appendChild(option);
                });
            }
            
            addPreparationToMenu(prepId) {
                if (!prepId) return;
                
                const data = this.getData();
                const preparation = data.preparations.find(p => p.id == prepId);
                
                if (!preparation) return;
                
                const container = document.getElementById('menu-preparations-container');
                
                const prepDiv = document.createElement('div');
                prepDiv.className = 'preparation-card';
                prepDiv.style.marginBottom = '15px';
                prepDiv.innerHTML = `
                    <div class="preparation-header">
                        <div class="preparation-name">${preparation.name}</div>
                        <div class="preparation-category">${preparation.category}</div>
                    </div>
                    <div class="preparation-description">${preparation.description}</div>
                    <div class="ingredients-list">
                        <h5>Ingredientes:</h5>
                        ${preparation.ingredients.map(ing => `
                            <div class="ingredient-item">
                                <span class="ingredient-name">${ing.name}</span>
                                <span class="ingredient-quantity">${ing.quantity}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 15px; font-size: 0.9rem;">
                        <strong>Instruções:</strong> ${preparation.instructions}
                    </div>
                `;
                
                container.appendChild(prepDiv);
                
                // Resetar select
                document.getElementById('menu-preparation-select').value = '';
                
                this.showMessage('success', 'Preparo adicionado ao cardápio');
            }
            
            saveMenu(event) {
                event.preventDefault();
                
                const data = this.getData();
                const newId = data.menus.length > 0 ? Math.max(...data.menus.map(m => m.id)) + 1 : 1;
                
                // Coletar refeições
                const meals = [];
                document.querySelectorAll('#meal-times-container .meal-time-group').forEach(group => {
                    const time = group.querySelector('h4').textContent;
                    const items = Array.from(group.querySelectorAll('.meal-item-input')).map(input => input.value).filter(v => v);
                    
                    if (items.length > 0) {
                        meals.push({ time, items });
                    }
                });
                
                const menu = {
                    id: newId,
                    patientId: parseInt(document.getElementById('menu-patient').value),
                    name: document.getElementById('menu-name').value,
                    description: document.getElementById('menu-description').value,
                    days: parseInt(document.getElementById('menu-days').value),
                    calories: parseInt(document.getElementById('menu-calories').value),
                    meals: meals,
                    createdAt: new Date().toISOString()
                };
                
                data.menus.push(menu);
                this.saveData(data);
                
                this.showMessage('success', 'Cardápio criado com sucesso!');
                this.closeModal('new-menu-modal');
                this.loadMenusPage();
                this.loadDashboard();
            }
            
            // ============================================
            // FUNÇÕES DA TABELA TACO
            // ============================================
            
            loadTACOPage() {
                const data = this.getData();
                
                let html = `
                    <div class="page-title">
                        <h2>Tabela TACO Completa</h2>
                        <div style="display: flex; gap: 15px;">
                            <div class="search-container" style="flex: 1;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="taco-search" placeholder="Buscar alimentos...">
                            </div>
                            <button class="btn" onclick="app.openModal('taco-management-modal')">
                                <i class="fas fa-cog"></i> Gerenciar
                            </button>
                            <button class="btn btn-secondary" onclick="app.exportTACOToExcel()">
                                <i class="fas fa-file-excel"></i> Exportar
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="taco-table">
                            <thead>
                                <tr>
                                    <th>Alimento</th>
                                    <th>Categoria</th>
                                    <th>Calorias (kcal)</th>
                                    <th>Proteínas (g)</th>
                                    <th>Carboidratos (g)</th>
                                    <th>Gorduras (g)</th>
                                    <th>Fibras (g)</th>
                                    <th>Medida Caseira</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.foods.forEach(food => {
                    html += `
                        <tr>
                            <td><strong>${food.name}</strong></td>
                            <td><span class="badge badge-info">${food.category}</span></td>
                            <td>${food.calories}</td>
                            <td>${food.protein}</td>
                            <td>${food.carbs}</td>
                            <td>${food.fat}</td>
                            <td>${food.fiber}</td>
                            <td><small>${food.homeMeasure}</small></td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;
                
                document.getElementById('taco-page').innerHTML = html;
                
                // Adicionar funcionalidade de busca
                const searchInput = document.getElementById('taco-search');
                searchInput.addEventListener('input', (e) => {
                    this.searchTACO(e.target.value);
                });
            }
            
            searchTACO(query) {
                const data = this.getData();
                const filtered = data.foods.filter(food => 
                    food.name.toLowerCase().includes(query.toLowerCase()) ||
                    food.category.toLowerCase().includes(query.toLowerCase())
                );
                
                const tbody = document.querySelector('#taco-table tbody');
                tbody.innerHTML = filtered.map(food => `
                    <tr>
                        <td><strong>${food.name}</strong></td>
                        <td><span class="badge badge-info">${food.category}</span></td>
                        <td>${food.calories}</td>
                        <td>${food.protein}</td>
                        <td>${food.carbs}</td>
                        <td>${food.fat}</td>
                        <td>${food.fiber}</td>
                        <td><small>${food.homeMeasure}</small></td>
                    </tr>
                `).join('');
            }
            
            loadTacoManagementTable() {
                const data = this.getData();
                const tbody = document.querySelector('#taco-management-table tbody');
                
                let html = '';
                data.foods.forEach(food => {
                    html += `
                        <tr>
                            <td><strong>${food.name}</strong></td>
                            <td>${food.category}</td>
                            <td>${food.calories}</td>
                            <td>${food.protein}</td>
                            <td>${food.carbs}</td>
                            <td>${food.fat}</td>
                            <td><small>${food.homeMeasure}</small></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-small" onclick="app.editFood(${food.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-small btn-danger" onclick="app.deleteFood(${food.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
                
                // Adicionar busca
                const searchInput = document.getElementById('taco-management-search');
                searchInput.addEventListener('input', (e) => {
                    this.searchTacoManagement(e.target.value);
                });
            }
            
            searchTacoManagement(query) {
                const data = this.getData();
                const filtered = data.foods.filter(food => 
                    food.name.toLowerCase().includes(query.toLowerCase()) ||
                    food.category.toLowerCase().includes(query.toLowerCase())
                );
                
                const tbody = document.querySelector('#taco-management-table tbody');
                tbody.innerHTML = filtered.map(food => `
                    <tr>
                        <td><strong>${food.name}</strong></td>
                        <td>${food.category}</td>
                        <td>${food.calories}</td>
                        <td>${food.protein}</td>
                        <td>${food.carbs}</td>
                        <td>${food.fat}</td>
                        <td><small>${food.homeMeasure}</small></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-small" onclick="app.editFood(${food.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-small btn-danger" onclick="app.deleteFood(${food.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            openAddFoodModal() {
                this.openModal('add-food-modal');
            }
            
            saveFood(event) {
                event.preventDefault();
                
                const data = this.getData();
                const newId = data.foods.length > 0 ? Math.max(...data.foods.map(f => f.id)) + 1 : 1;
                
                const food = {
                    id: newId,
                    name: document.getElementById('food-name').value,
                    category: document.getElementById('food-category').value,
                    calories: parseFloat(document.getElementById('food-calories').value),
                    protein: parseFloat(document.getElementById('food-protein').value) || 0,
                    carbs: parseFloat(document.getElementById('food-carbs').value) || 0,
                    fat: parseFloat(document.getElementById('food-fat').value) || 0,
                    fiber: parseFloat(document.getElementById('food-fiber').value) || 0,
                    sodium: parseFloat(document.getElementById('food-sodium').value) || 0,
                    homeMeasure: document.getElementById('food-home-measure').value
                };
                
                data.foods.push(food);
                this.saveData(data);
                
                this.showMessage('success', 'Alimento adicionado com sucesso!');
                this.closeModal('add-food-modal');
                this.loadTacoManagementTable();
                this.loadTACOPage();
            }
            
            deleteFood(foodId) {
                if (confirm('Tem certeza que deseja excluir este alimento?')) {
                    const data = this.getData();
                    data.foods = data.foods.filter(f => f.id !== foodId);
                    this.saveData(data);
                    
                    this.showMessage('success', 'Alimento excluído com sucesso!');
                    this.loadTacoManagementTable();
                    this.loadTACOPage();
                }
            }
            
            // ============================================
            // FUNÇÕES DE PREPAROS
            // ============================================
            
            loadPreparationsPage() {
                const data = this.getData();
                
                let html = `
                    <div class="page-title">
                        <h2>Preparos Pré-configurados</h2>
                        <div>
                            <button class="btn" onclick="app.createNewPreparation()">
                                <i class="fas fa-plus"></i> Novo Preparo
                            </button>
                        </div>
                    </div>
                    
                    <div class="preparations-container">
                `;
                
                data.preparations.forEach(preparation => {
                    html += `
                        <div class="preparation-card">
                            <div class="preparation-header">
                                <div class="preparation-name">${preparation.name}</div>
                                <div class="preparation-category">${preparation.category}</div>
                            </div>
                            <div class="preparation-description">
                                ${preparation.description}
                            </div>
                            <div style="display: flex; gap: 10px; margin: 15px 0;">
                                <div style="background: rgba(42, 157, 143, 0.1); padding: 8px 15px; border-radius: 20px; color: var(--primary-color); font-weight: 600;">
                                    ${preparation.calories} kcal
                                </div>
                                <div style="background: rgba(233, 196, 106, 0.1); padding: 8px 15px; border-radius: 20px; color: var(--warning-color); font-weight: 600;">
                                    ${preparation.protein}g proteína
                                </div>
                                <div style="background: rgba(38, 70, 83, 0.1); padding: 8px 15px; border-radius: 20px; color: var(--accent-color); font-weight: 600;">
                                    ${preparation.carbs}g carbs
                                </div>
                            </div>
                            <div class="ingredients-list">
                                <h5>Ingredientes:</h5>
                                ${preparation.ingredients.map(ing => `
                                    <div class="ingredient-item">
                                        <span class="ingredient-name">${ing.name}</span>
                                        <span class="ingredient-quantity">${ing.quantity}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 15px; font-size: 0.9rem;">
                                <strong>Instruções:</strong> ${preparation.instructions}
                            </div>
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn btn-small" onclick="app.addPreparationToCurrentMenu(${preparation.id})">
                                    <i class="fas fa-utensils"></i> Usar no Cardápio
                                </button>
                                <button class="btn btn-small btn-secondary" onclick="app.editPreparation(${preparation.id})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                document.getElementById('preparations-page').innerHTML = html;
            }
            
            createNewPreparation() {
                this.showMessage('info', 'Funcionalidade em desenvolvimento. Em breve você poderá criar novos preparos.');
            }
            
            addPreparationToCurrentMenu(prepId) {
                this.openModal('new-menu-modal', () => {
                    this.addPreparationToMenu(prepId);
                });
            }
            
            // ============================================
            // FUNÇÕES DE RELATÓRIOS
            // ============================================
            
            loadReportsPage() {
                const data = this.getData();
                
                let html = `
                    <div class="page-title">
                        <h2>Relatórios e Exportações</h2>
                    </div>
                    
                    <div class="export-section">
                        <h3 style="color: var(--accent-color); margin-bottom: 25px;">Exportar Dados</h3>
                        
                        <div class="export-buttons">
                            <button class="export-btn export-pdf" onclick="app.exportAllPatientsPDF()">
                                <i class="fas fa-users"></i>
                                <div>
                                    <strong>Lista de Pacientes</strong>
                                    <small style="display: block; font-weight: normal; opacity: 0.8;">PDF com todos os pacientes</small>
                                </div>
                            </button>
                            
                            <button class="export-btn export-excel" onclick="app.exportAllPatientsExcel()">
                                <i class="fas fa-users"></i>
                                <div>
                                    <strong>Pacientes (Excel)</strong>
                                    <small style="display: block; font-weight: normal; opacity: 0.8;">Dados completos em planilha</small>
                                </div>
                            </button>
                            
                            <button class="export-btn export-pdf" onclick="app.exportAllAssessmentsPDF()">
                                <i class="fas fa-weight"></i>
                                <div>
                                    <strong>Histórico de Avaliações</strong>
                                    <small style="display: block; font-weight: normal; opacity: 0.8;">Todas as avaliações em PDF</small>
                                </div>
                            </button>
                            
                            <button class="export-btn export-excel" onclick="app.exportAllMenusExcel()">
                                <i class="fas fa-utensils"></i>
                                <div>
                                    <strong>Cardápios (Excel)</strong>
                                    <small style="display: block; font-weight: normal; opacity: 0.8;">Todos os cardápios</small>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="export-section" style="margin-top: 30px;">
                        <h3 style="color: var(--accent-color); margin-bottom: 25px;">Relatórios Avançados</h3>
                        
                        <div class="export-buttons">
                            <button class="export-btn" onclick="app.generateCompleteReport()">
                                <i class="fas fa-chart-bar"></i>
                                <div>
                                    <strong>Relatório Completo</strong>
                                    <small style="display: block; font-weight: normal; opacity: 0.8;">Todos os dados do sistema</small>
                                </div>
                            </button>
                            
                            <button class="export-btn" onclick="app.exportNutritionalAnalysis()">
                                <i class="fas fa-chart-pie"></i>
                                <div>
                                    <strong>Análise Nutricional</strong>
                                    <small style="display: block; font-weight: normal; opacity: 0.8;">Estatísticas e gráficos</small>
                                </div>
                            </button>
                            
                            <button class="export-btn" onclick="app.exportTACOToPDF()">
                                <i class="fas fa-database"></i>
                                <div>
                                    <strong>Tabela TACO (PDF)</strong>
                                    <small style="display: block; font-weight: normal; opacity: 0.8;">Catálogo completo</small>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px; background: white; border-radius: var(--border-radius); padding: 30px; box-shadow: var(--box-shadow);">
                        <h3 style="color: var(--accent-color); margin-bottom: 20px;">Estatísticas do Sistema</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, rgba(42, 157, 143, 0.05) 100%); border-radius: var(--border-radius);">
                                <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary-color);">${data.patients.length}</div>
                                <div style="color: var(--gray-color);">Pacientes</div>
                            </div>
                            
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(233, 196, 106, 0.1) 0%, rgba(233, 196, 106, 0.05) 100%); border-radius: var(--border-radius);">
                                <div style="font-size: 2.5rem; font-weight: bold; color: var(--warning-color);">${data.assessments.length}</div>
                                <div style="color: var(--gray-color);">Avaliações</div>
                            </div>
                            
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(38, 70, 83, 0.1) 0%, rgba(38, 70, 83, 0.05) 100%); border-radius: var(--border-radius);">
                                <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent-color);">${data.menus.length}</div>
                                <div style="color: var(--gray-color);">Cardápios</div>
                            </div>
                            
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(231, 111, 81, 0.1) 0%, rgba(231, 111, 81, 0.05) 100%); border-radius: var(--border-radius);">
                                <div style="font-size: 2.5rem; font-weight: bold; color: var(--danger-color);">${data.foods.length}</div>
                                <div style="color: var(--gray-color);">Alimentos TACO</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('reports-page').innerHTML = html;
            }
            
            // ============================================
            // FUNÇÕES DE EXPORTAÇÃO (TODAS FUNCIONAIS)
            // ============================================
            
            exportAssessmentPDF(assessmentId = null) {
                try {
                    const data = this.getData();
                    let assessment;
                    
                    if (assessmentId) {
                        assessment = data.assessments.find(a => a.id === assessmentId);
                    } else {
                        // Usar dados do formulário atual
                        const weight = parseFloat(document.getElementById('assessment-weight').value);
                        const height = parseFloat(document.getElementById('assessment-height').value);
                        
                        if (!weight || !height) {
                            this.showMessage('error', 'Preencha peso e altura primeiro');
                            return;
                        }
                        
                        assessment = {
                            weight: weight,
                            height: height,
                            date: document.getElementById('assessment-date').value,
                            patientId: document.getElementById('assessment-patient').value
                        };
                    }
                    
                    if (!assessment) {
                        this.showMessage('error', 'Avaliação não encontrada');
                        return;
                    }
                    
                    const patient = data.patients.find(p => p.id === assessment.patientId);
                    const imc = this.calculateIMC(assessment.weight, assessment.height);
                    
                    // Criar conteúdo HTML para o PDF
                    const content = `
                        <html>
                            <head>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                                    h1 { color: #2A9D8F; border-bottom: 2px solid #2A9D8F; padding-bottom: 10px; }
                                    h2 { color: #264653; margin-top: 25px; }
                                    .header { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
                                    .result-box { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; }
                                    .imc-indicator { display: inline-block; padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-left: 10px; }
                                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                    th { background: #264653; color: white; padding: 12px; text-align: left; }
                                    td { padding: 10px; border-bottom: 1px solid #ddd; }
                                    .footer { margin-top: 50px; text-align: center; color: #666; font-size: 0.9em; }
                                </style>
                            </head>
                            <body>
                                <h1>Relatório de Avaliação Antropométrica</h1>
                                
                                <div class="header">
                                    <p><strong>Paciente:</strong> ${patient ? patient.name : 'Não informado'}</p>
                                    <p><strong>Data da Avaliação:</strong> ${assessment.date}</p>
                                    <p><strong>Nutricionista:</strong> Dra. Maria Oliveira - CRN 12345</p>
                                </div>
                                
                                <h2>Resultados da Avaliação</h2>
                                
                                <table>
                                    <tr>
                                        <th>Parâmetro</th>
                                        <th>Valor</th>
                                        <th>Classificação</th>
                                    </tr>
                                    <tr>
                                        <td><strong>Peso</strong></td>
                                        <td>${assessment.weight} kg</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Altura</strong></td>
                                        <td>${assessment.height} cm</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Índice de Massa Corporal (IMC)</strong></td>
                                        <td>${imc.imc} kg/m²</td>
                                        <td><span class="imc-indicator" style="background: ${imc.colorClass === 'imc-abaixo' ? '#FFE0B2' : imc.colorClass === 'imc-eutrofico' ? '#C8E6C9' : imc.colorClass === 'imc-sobrepeso' ? '#FFF3E0' : '#FFCDD2'}; color: ${imc.colorClass === 'imc-abaixo' ? '#EF6C00' : imc.colorClass === 'imc-eutrofico' ? '#2E7D32' : imc.colorClass === 'imc-sobrepeso' ? '#F57C00' : '#C62828'};">${imc.classification}</span></td>
                                    </tr>
                                </table>
                                
                                ${assessment.waist ? `
                                <h2>Medidas de Circunferência</h2>
                                <table>
                                    <tr>
                                        <th>Medida</th>
                                        <th>Valor (cm)</th>
                                    </tr>
                                    ${assessment.waist ? `<tr><td>Cintura</td><td>${assessment.waist} cm</td></tr>` : ''}
                                    ${assessment.abdomen ? `<tr><td>Abdominal</td><td>${assessment.abdomen} cm</td></tr>` : ''}
                                    ${assessment.hip ? `<tr><td>Quadril</td><td>${assessment.hip} cm</td></tr>` : ''}
                                </table>
                                ` : ''}
                                
                                ${assessment.notes ? `
                                <h2>Observações</h2>
                                <div class="result-box">
                                    ${assessment.notes}
                                </div>
                                ` : ''}
                                
                                <div class="footer">
                                    <p>Relatório gerado por NutriVision Pro - ${new Date().toLocaleDateString()}</p>
                                    <p>Este relatório tem validade de 30 dias</p>
                                </div>
                            </body>
                        </html>
                    `;
                    
                    // Criar janela para impressão/PDF
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(content);
                    printWindow.document.close();
                    printWindow.print();
                    
                    this.showMessage('success', 'PDF gerado com sucesso!');
                } catch (error) {
                    console.error('Erro ao gerar PDF:', error);
                    this.showMessage('error', 'Erro ao gerar PDF. Tente novamente.');
                }
            }
            
            exportAssessmentExcel(assessmentId = null) {
                try {
                    const data = this.getData();
                    let assessment;
                    
                    if (assessmentId) {
                        assessment = data.assessments.find(a => a.id === assessmentId);
                    }
                    
                    if (!assessment) {
                        this.showMessage('error', 'Avaliação não encontrada');
                        return;
                    }
                    
                    const patient = data.patients.find(p => p.id === assessment.patientId);
                    const imc = this.calculateIMC(assessment.weight, assessment.height);
                    
                    // Criar dados para a planilha
                    const worksheetData = [
                        ['Relatório de Avaliação Antropométrica'],
                        [''],
                        ['Paciente:', patient ? patient.name : 'Não informado'],
                        ['Data da Avaliação:', assessment.date],
                        ['Nutricionista:', 'Dra. Maria Oliveira - CRN 12345'],
                        [''],
                        ['RESULTADOS DA AVALIAÇÃO'],
                        ['Parâmetro', 'Valor', 'Classificação'],
                        ['Peso', `${assessment.weight} kg`, ''],
                        ['Altura', `${assessment.height} cm`, ''],
                        ['IMC', `${imc.imc} kg/m²`, imc.classification],
                        [''],
                        ['MEDIDAS DE CIRCUNFERÊNCIA'],
                        ['Medida', 'Valor (cm)'],
                        ['Cintura', assessment.waist || ''],
                        ['Abdominal', assessment.abdomen || ''],
                        ['Quadril', assessment.hip || ''],
                        [''],
                        ['OBSERVAÇÕES'],
                        [assessment.notes || ''],
                        [''],
                        ['Relatório gerado por NutriVision Pro', new Date().toLocaleDateString()]
                    ];
                    
                    // Criar worksheet
                    const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                    
                    // Criar workbook e adicionar worksheet
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Avaliação');
                    
                    // Gerar nome do arquivo
                    const fileName = `avaliacao_${patient ? patient.name.replace(/\s+/g, '_') : 'paciente'}_${assessment.date}.xlsx`;
                    
                    // Salvar arquivo
                    XLSX.writeFile(wb, fileName);
                    
                    this.showMessage('success', 'Excel gerado com sucesso!');
                } catch (error) {
                    console.error('Erro ao gerar Excel:', error);
                    this.showMessage('error', 'Erro ao gerar Excel. Tente novamente.');
                }
            }
            
            exportPatientReport(patientId) {
                const data = this.getData();
                const patient = data.patients.find(p => p.id === patientId);
                
                if (!patient) {
                    this.showMessage('error', 'Paciente não encontrado');
                    return;
                }
                
                const assessments = data.assessments.filter(a => a.patientId === patientId);
                const menus = data.menus.filter(m => m.patientId === patientId);
                const age = this.calculateAge(patient.birthdate);
                
                // Criar conteúdo para impressão/PDF
                const content = `
                    <html>
                        <head>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                                h1 { color: #2A9D8F; border-bottom: 2px solid #2A9D8F; padding-bottom: 10px; }
                                h2 { color: #264653; margin-top: 25px; }
                                .patient-info { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
                                .section { margin: 30px 0; }
                                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                th { background: #264653; color: white; padding: 12px; text-align: left; }
                                td { padding: 10px; border-bottom: 1px solid #ddd; }
                                .footer { margin-top: 50px; text-align: center; color: #666; font-size: 0.9em; }
                            </style>
                        </head>
                        <body>
                            <h1>Ficha do Paciente</h1>
                            
                            <div class="patient-info">
                                <p><strong>Nome:</strong> ${patient.name}</p>
                                <p><strong>Idade:</strong> ${age} anos</p>
                                <p><strong>Telefone:</strong> ${patient.phone}</p>
                                <p><strong>Email:</strong> ${patient.email || 'Não informado'}</p>
                                <p><strong>Data de Nascimento:</strong> ${patient.birthdate}</p>
                                <p><strong>Objetivo:</strong> ${patient.objective}</p>
                                ${patient.notes ? `<p><strong>Observações:</strong> ${patient.notes}</p>` : ''}
                            </div>
                            
                            ${assessments.length > 0 ? `
                            <div class="section">
                                <h2>Histórico de Avaliações</h2>
                                <table>
                                    <tr>
                                        <th>Data</th>
                                        <th>Peso (kg)</th>
                                        <th>Altura (cm)</th>
                                        <th>IMC</th>
                                        <th>Classificação</th>
                                    </tr>
                                    ${assessments.map(assess => {
                                        const imc = this.calculateIMC(assess.weight, assess.height);
                                        return `
                                            <tr>
                                                <td>${assess.date}</td>
                                                <td>${assess.weight}</td>
                                                <td>${assess.height}</td>
                                                <td>${imc.imc}</td>
                                                <td>${imc.classification}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </table>
                            </div>
                            ` : ''}
                            
                            ${menus.length > 0 ? `
                            <div class="section">
                                <h2>Cardápios Prescritos</h2>
                                <table>
                                    <tr>
                                        <th>Nome do Cardápio</th>
                                        <th>Duração</th>
                                        <th>Calorias Diárias</th>
                                        <th>Data de Criação</th>
                                    </tr>
                                    ${menus.map(menu => `
                                        <tr>
                                            <td>${menu.name}</td>
                                            <td>${menu.days} dias</td>
                                            <td>${menu.calories} kcal</td>
                                            <td>${new Date(menu.createdAt).toLocaleDateString()}</td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </div>
                            ` : ''}
                            
                            <div class="footer">
                                <p>Relatório gerado por NutriVision Pro - ${new Date().toLocaleDateString()}</p>
                                <p>Dra. Maria Oliveira - CRN 12345</p>
                            </div>
                        </body>
                    </html>
                `;
                
                // Criar janela para impressão/PDF
                const printWindow = window.open('', '_blank');
                printWindow.document.write(content);
                printWindow.document.close();
                printWindow.print();
                
                this.showMessage('success', 'Relatório do paciente gerado com sucesso!');
            }
            
            exportMenuPDF(menuId = null) {
                try {
                    const data = this.getData();
                    let menu;
                    
                    if (menuId) {
                        menu = data.menus.find(m => m.id === menuId);
                    }
                    
                    if (!menu) {
                        this.showMessage('error', 'Cardápio não encontrado');
                        return;
                    }
                    
                    const patient = data.patients.find(p => p.id === menu.patientId);
                    
                    // Criar conteúdo para o PDF
                    const content = `
                        <html>
                            <head>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                                    h1 { color: #2A9D8F; border-bottom: 2px solid #2A9D8F; padding-bottom: 10px; }
                                    h2 { color: #264653; margin-top: 25px; }
                                    .header { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
                                    .meal-section { margin: 25px 0; }
                                    .meal-title { background: #2A9D8F; color: white; padding: 10px 15px; border-radius: 5px; font-weight: bold; }
                                    .meal-items { background: white; border: 1px solid #ddd; border-radius: 0 0 5px 5px; padding: 15px; }
                                    .meal-item { padding: 5px 0; border-bottom: 1px dashed #eee; }
                                    .meal-item:last-child { border-bottom: none; }
                                    .footer { margin-top: 50px; text-align: center; color: #666; font-size: 0.9em; }
                                </style>
                            </head>
                            <body>
                                <h1>Cardápio Nutricional</h1>
                                
                                <div class="header">
                                    <p><strong>Nome do Cardápio:</strong> ${menu.name}</p>
                                    <p><strong>Paciente:</strong> ${patient ? patient.name : 'Não informado'}</p>
                                    <p><strong>Duração:</strong> ${menu.days} dias</p>
                                    <p><strong>Calorias Diárias:</strong> ${menu.calories} kcal</p>
                                    ${menu.description ? `<p><strong>Descrição:</strong> ${menu.description}</p>` : ''}
                                    <p><strong>Nutricionista:</strong> Dra. Maria Oliveira - CRN 12345</p>
                                </div>
                                
                                <h2>Plano Alimentar Diário</h2>
                                
                                ${menu.meals && menu.meals.length > 0 ? menu.meals.map(meal => `
                                    <div class="meal-section">
                                        <div class="meal-title">${meal.time}</div>
                                        <div class="meal-items">
                                            ${meal.items.map(item => `
                                                <div class="meal-item">• ${item}</div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('') : '<p>Nenhuma refeição cadastrada neste cardápio.</p>'}
                                
                                <div class="footer">
                                    <p>Cardápio gerado por NutriVision Pro - ${new Date().toLocaleDateString()}</p>
                                    <p>Este cardápio é personalizado e deve ser seguido conforme orientação nutricional</p>
                                </div>
                            </body>
                        </html>
                    `;
                    
                    // Criar janela para impressão/PDF
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(content);
                    printWindow.document.close();
                    printWindow.print();
                    
                    this.showMessage('success', 'Cardápio exportado em PDF com sucesso!');
                } catch (error) {
                    console.error('Erro ao gerar PDF do cardápio:', error);
                    this.showMessage('error', 'Erro ao gerar PDF. Tente novamente.');
                }
            }
            
            exportMenuExcel(menuId = null) {
                try {
                    const data = this.getData();
                    let menu;
                    
                    if (menuId) {
                        menu = data.menus.find(m => m.id === menuId);
                    }
                    
                    if (!menu) {
                        this.showMessage('error', 'Cardápio não encontrado');
                        return;
                    }
                    
                    const patient = data.patients.find(p => p.id === menu.patientId);
                    
                    // Criar dados para a planilha
                    const worksheetData = [
                        ['CARDÁPIO NUTRICIONAL'],
                        [''],
                        ['Nome do Cardápio:', menu.name],
                        ['Paciente:', patient ? patient.name : 'Não informado'],
                        ['Duração:', `${menu.days} dias`],
                        ['Calorias Diárias:', `${menu.calories} kcal`],
                        ['Descrição:', menu.description || ''],
                        ['Nutricionista:', 'Dra. Maria Oliveira - CRN 12345'],
                        [''],
                        ['PLANO ALIMENTAR DIÁRIO'],
                        ['Refeição', 'Alimentos'],
                        ...(menu.meals && menu.meals.length > 0 ? 
                            menu.meals.flatMap(meal => 
                                meal.items.map((item, index) => [
                                    index === 0 ? meal.time : '',
                                    item
                                ])
                            ) : [['', 'Nenhuma refeição cadastrada']]
                        ),
                        [''],
                        ['OBSERVAÇÕES IMPORTANTES'],
                        ['1. Consuma os alimentos nos horários indicados'],
                        ['2. Beba pelo menos 2 litros de água por dia'],
                        ['3. Pratique atividade física regularmente'],
                        ['4. Siga as porções indicadas'],
                        [''],
                        ['Cardápio gerado por NutriVision Pro', new Date().toLocaleDateString()]
                    ];
                    
                    // Criar worksheet
                    const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                    
                    // Criar workbook
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Cardápio');
                    
                    // Gerar nome do arquivo
                    const fileName = `cardapio_${menu.name.replace(/\s+/g, '_')}.xlsx`;
                    
                    // Salvar arquivo
                    XLSX.writeFile(wb, fileName);
                    
                    this.showMessage('success', 'Cardápio exportado em Excel com sucesso!');
                } catch (error) {
                    console.error('Erro ao gerar Excel do cardápio:', error);
                    this.showMessage('error', 'Erro ao gerar Excel. Tente novamente.');
                }
            }
            
            exportTACOToExcel() {
                try {
                    const data = this.getData();
                    
                    // Criar dados para a planilha
                    const worksheetData = [
                        ['TABELA TACO - COMPOSIÇÃO DE ALIMENTOS'],
                        [''],
                        ['Alimento', 'Categoria', 'Calorias (kcal)', 'Proteínas (g)', 'Carboidratos (g)', 'Gorduras (g)', 'Fibras (g)', 'Sódio (mg)', 'Medida Caseira'],
                        ...data.foods.map(food => [
                            food.name,
                            food.category,
                            food.calories,
                            food.protein,
                            food.carbs,
                            food.fat,
                            food.fiber,
                            food.sodium,
                            food.homeMeasure
                        ]),
                        [''],
                        ['Tabela gerada por NutriVision Pro', new Date().toLocaleDateString()]
                    ];
                    
                    // Criar worksheet
                    const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                    
                    // Criar workbook
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'TACO');
                    
                    // Salvar arquivo
                    XLSX.writeFile(wb, 'tabela_taco_completa.xlsx');
                    
                    this.showMessage('success', 'Tabela TACO exportada com sucesso!');
                } catch (error) {
                    console.error('Erro ao exportar TACO:', error);
                    this.showMessage('error', 'Erro ao exportar TACO. Tente novamente.');
                }
            }
            
            exportAllPatientsPDF() {
                try {
                    const data = this.getData();
                    
                    if (data.patients.length === 0) {
                        this.showMessage('info', 'Não há pacientes para exportar');
                        return;
                    }
                    
                    // Criar conteúdo para o PDF
                    let content = `
                        <html>
                            <head>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                                    h1 { color: #2A9D8F; border-bottom: 2px solid #2A9D8F; padding-bottom: 10px; }
                                    h2 { color: #264653; margin-top: 25px; }
                                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                    th { background: #264653; color: white; padding: 12px; text-align: left; }
                                    td { padding: 10px; border-bottom: 1px solid #ddd; }
                                    .footer { margin-top: 50px; text-align: center; color: #666; font-size: 0.9em; }
                                    .summary { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 30px 0; }
                                </style>
                            </head>
                            <body>
                                <h1>Lista de Pacientes - NutriVision Pro</h1>
                                
                                <div class="summary">
                                    <p><strong>Total de Pacientes:</strong> ${data.patients.length}</p>
                                    <p><strong>Data do Relatório:</strong> ${new Date().toLocaleDateString()}</p>
                                    <p><strong>Nutricionista:</strong> Dra. Maria Oliveira - CRN 12345</p>
                                </div>
                                
                                <table>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Telefone</th>
                                        <th>Email</th>
                                        <th>Idade</th>
                                        <th>Objetivo</th>
                                        <th>Status</th>
                                    </tr>
                    `;
                    
                    data.patients.forEach(patient => {
                        const age = this.calculateAge(patient.birthdate);
                        content += `
                            <tr>
                                <td>${patient.name}</td>
                                <td>${patient.phone}</td>
                                <td>${patient.email || '-'}</td>
                                <td>${age} anos</td>
                                <td>${patient.objective}</td>
                                <td>${patient.status === 'active' ? 'Ativo' : 'Inativo'}</td>
                            </tr>
                        `;
                    });
                    
                    content += `
                                </table>
                                
                                <div class="footer">
                                    <p>Relatório gerado por NutriVision Pro - ${new Date().toLocaleDateString()}</p>
                                    <p>Confidencial - Uso exclusivo do nutricionista</p>
                                </div>
                            </body>
                        </html>
                    `;
                    
                    // Criar janela para impressão/PDF
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(content);
                    printWindow.document.close();
                    printWindow.print();
                    
                    this.showMessage('success', 'Lista de pacientes exportada em PDF!');
                } catch (error) {
                    console.error('Erro ao exportar pacientes:', error);
                    this.showMessage('error', 'Erro ao exportar PDF. Tente novamente.');
                }
            }
            
            exportAllPatientsExcel() {
                try {
                    const data = this.getData();
                    
                    if (data.patients.length === 0) {
                        this.showMessage('info', 'Não há pacientes para exportar');
                        return;
                    }
                    
                    // Criar dados para a planilha
                    const worksheetData = [
                        ['LISTA DE PACIENTES - NUTRIVISION PRO'],
                        ['Data do Relatório:', new Date().toLocaleDateString()],
                        ['Nutricionista:', 'Dra. Maria Oliveira - CRN 12345'],
                        ['Total de Pacientes:', data.patients.length],
                        [''],
                        ['Nome', 'Telefone', 'Email', 'Data Nascimento', 'Idade', 'Objetivo', 'Status', 'Observações'],
                        ...data.patients.map(patient => [
                            patient.name,
                            patient.phone,
                            patient.email || '',
                            patient.birthdate,
                            this.calculateAge(patient.birthdate),
                            patient.objective,
                            patient.status === 'active' ? 'Ativo' : 'Inativo',
                            patient.notes || ''
                        ]),
                        [''],
                        ['Relatório gerado por NutriVision Pro', new Date().toLocaleDateString()]
                    ];
                    
                    // Criar worksheet
                    const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                    
                    // Criar workbook
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Pacientes');
                    
                    // Salvar arquivo
                    XLSX.writeFile(wb, `pacientes_${new Date().toISOString().split('T')[0]}.xlsx`);
                    
                    this.showMessage('success', 'Pacientes exportados em Excel com sucesso!');
                } catch (error) {
                    console.error('Erro ao exportar pacientes Excel:', error);
                    this.showMessage('error', 'Erro ao exportar Excel. Tente novamente.');
                }
            }
            
            exportAllAssessmentsPDF() {
                try {
                    const data = this.getData();
                    
                    if (data.assessments.length === 0) {
                        this.showMessage('info', 'Não há avaliações para exportar');
                        return;
                    }
                    
                    // Criar conteúdo para o PDF
                    let content = `
                        <html>
                            <head>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                                    h1 { color: #2A9D8F; border-bottom: 2px solid #2A9D8F; padding-bottom: 10px; }
                                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                    th { background: #264653; color: white; padding: 12px; text-align: left; }
                                    td { padding: 10px; border-bottom: 1px solid #ddd; }
                                    .footer { margin-top: 50px; text-align: center; color: #666; font-size: 0.9em; }
                                    .summary { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 30px 0; }
                                </style>
                            </head>
                            <body>
                                <h1>Histórico de Avaliações - NutriVision Pro</h1>
                                
                                <div class="summary">
                                    <p><strong>Total de Avaliações:</strong> ${data.assessments.length}</p>
                                    <p><strong>Período:</strong> Todas as avaliações</p>
                                    <p><strong>Data do Relatório:</strong> ${new Date().toLocaleDateString()}</p>
                                </div>
                                
                                <table>
                                    <tr>
                                        <th>Data</th>
                                        <th>Paciente</th>
                                        <th>Peso (kg)</th>
                                        <th>Altura (cm)</th>
                                        <th>IMC</th>
                                        <th>Classificação</th>
                                    </tr>
                    `;
                    
                    data.assessments.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(assessment => {
                        const patient = data.patients.find(p => p.id === assessment.patientId);
                        const imc = this.calculateIMC(assessment.weight, assessment.height);
                        
                        content += `
                            <tr>
                                <td>${assessment.date}</td>
                                <td>${patient ? patient.name : 'Paciente não encontrado'}</td>
                                <td>${assessment.weight}</td>
                                <td>${assessment.height}</td>
                                <td>${imc.imc}</td>
                                <td>${imc.classification}</td>
                            </tr>
                        `;
                    });
                    
                    content += `
                                </table>
                                
                                <div class="footer">
                                    <p>Relatório gerado por NutriVision Pro - ${new Date().toLocaleDateString()}</p>
                                    <p>Confidencial - Uso exclusivo do nutricionista</p>
                                </div>
                            </body>
                        </html>
                    `;
                    
                    // Criar janela para impressão/PDF
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(content);
                    printWindow.document.close();
                    printWindow.print();
                    
                    this.showMessage('success', 'Histórico de avaliações exportado em PDF!');
                } catch (error) {
                    console.error('Erro ao exportar avaliações:', error);
                    this.showMessage('error', 'Erro ao exportar PDF. Tente novamente.');
                }
            }
            
            exportAllMenusExcel() {
                try {
                    const data = this.getData();
                    
                    if (data.menus.length === 0) {
                        this.showMessage('info', 'Não há cardápios para exportar');
                        return;
                    }
                    
                    // Criar dados para a planilha
                    const worksheetData = [
                        ['CARDÁPIOS - NUTRIVISION PRO'],
                        ['Data do Relatório:', new Date().toLocaleDateString()],
                        ['Total de Cardápios:', data.menus.length],
                        [''],
                        ['ID', 'Nome', 'Paciente', 'Duração (dias)', 'Calorias Diárias', 'Descrição', 'Data Criação'],
                        ...data.menus.map(menu => {
                            const patient = data.patients.find(p => p.id === menu.patientId);
                            return [
                                menu.id,
                                menu.name,
                                patient ? patient.name : 'Não informado',
                                menu.days,
                                menu.calories,
                                menu.description || '',
                                new Date(menu.createdAt).toLocaleDateString()
                            ];
                        }),
                        [''],
                        ['Relatório gerado por NutriVision Pro', new Date().toLocaleDateString()]
                    ];
                    
                    // Criar worksheet
                    const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                    
                    // Criar workbook
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Cardápios');
                    
                    // Salvar arquivo
                    XLSX.writeFile(wb, `cardapios_${new Date().toISOString().split('T')[0]}.xlsx`);
                    
                    this.showMessage('success', 'Cardápios exportados em Excel com sucesso!');
                } catch (error) {
                    console.error('Erro ao exportar cardápios Excel:', error);
                    this.showMessage('error', 'Erro ao exportar Excel. Tente novamente.');
                }
            }
            
            generateCompleteReport() {
                try {
                    const data = this.getData();
                    
                    // Criar conteúdo para o PDF
                    let content = `
                        <html>
                            <head>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                                    h1 { color: #2A9D8F; border-bottom: 2px solid #2A9D8F; padding-bottom: 10px; }
                                    h2 { color: #264653; margin-top: 30px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
                                    .summary { background: #f8f9fa; padding: 25px; border-radius: 10px; margin: 30px 0; }
                                    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0; }
                                    .stat-box { background: white; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #ddd; }
                                    .stat-number { font-size: 2rem; font-weight: bold; color: #2A9D8F; }
                                    .stat-label { color: #666; margin-top: 10px; }
                                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                    th { background: #264653; color: white; padding: 12px; text-align: left; }
                                    td { padding: 10px; border-bottom: 1px solid #ddd; }
                                    .footer { margin-top: 50px; text-align: center; color: #666; font-size: 0.9em; }
                                </style>
                            </head>
                            <body>
                                <h1>Relatório Completo - NutriVision Pro</h1>
                                
                                <div class="summary">
                                    <h2>Resumo do Sistema</h2>
                                    <div class="stats-grid">
                                        <div class="stat-box">
                                            <div class="stat-number">${data.patients.length}</div>
                                            <div class="stat-label">Pacientes</div>
                                        </div>
                                        <div class="stat-box">
                                            <div class="stat-number">${data.assessments.length}</div>
                                            <div class="stat-label">Avaliações</div>
                                        </div>
                                        <div class="stat-box">
                                            <div class="stat-number">${data.menus.length}</div>
                                            <div class="stat-label">Cardápios</div>
                                        </div>
                                        <div class="stat-box">
                                            <div class="stat-number">${data.foods.length}</div>
                                            <div class="stat-label">Alimentos TACO</div>
                                        </div>
                                    </div>
                                    
                                    <p><strong>Data do Relatório:</strong> ${new Date().toLocaleDateString()}</p>
                                    <p><strong>Nutricionista:</strong> Dra. Maria Oliveira - CRN 12345</p>
                                </div>
                                
                                <h2>Distribuição por Objetivo</h2>
                                <table>
                                    <tr>
                                        <th>Objetivo</th>
                                        <th>Quantidade</th>
                                        <th>Porcentagem</th>
                                    </tr>
                    `;
                    
                    // Calcular distribuição por objetivo
                    const objectives = {};
                    data.patients.forEach(patient => {
                        objectives[patient.objective] = (objectives[patient.objective] || 0) + 1;
                    });
                    
                    Object.entries(objectives).forEach(([obj, count]) => {
                        const percentage = ((count / data.patients.length) * 100).toFixed(1);
                        content += `
                            <tr>
                                <td>${obj}</td>
                                <td>${count}</td>
                                <td>${percentage}%</td>
                            </tr>
                        `;
                    });
                    
                    content += `
                                </table>
                                
                                <h2>Últimas Avaliações</h2>
                                <table>
                                    <tr>
                                        <th>Data</th>
                                        <th>Paciente</th>
                                        <th>IMC</th>
                                        <th>Status</th>
                                    </tr>
                    `;
                    
                    // Últimas 5 avaliações
                    const recentAssessments = data.assessments
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 5);
                    
                    recentAssessments.forEach(assessment => {
                        const patient = data.patients.find(p => p.id === assessment.patientId);
                        const imc = this.calculateIMC(assessment.weight, assessment.height);
                        
                        content += `
                            <tr>
                                <td>${assessment.date}</td>
                                <td>${patient ? patient.name : 'Não informado'}</td>
                                <td>${imc.imc}</td>
                                <td>${imc.classification}</td>
                            </tr>
                        `;
                    });
                    
                    content += `
                                </table>
                                
                                <div class="footer">
                                    <p>Relatório gerado automaticamente por NutriVision Pro</p>
                                    <p>${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
                                </div>
                            </body>
                        </html>
                    `;
                    
                    // Criar janela para impressão/PDF
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(content);
                    printWindow.document.close();
                    printWindow.print();
                    
                    this.showMessage('success', 'Relatório completo gerado com sucesso!');
                } catch (error) {
                    console.error('Erro ao gerar relatório completo:', error);
                    this.showMessage('error', 'Erro ao gerar relatório. Tente novamente.');
                }
            }
            
            // ============================================
            // FUNÇÕES AUXILIARES
            // ============================================
            
            showMessage(type, text) {
                // Remover mensagens existentes
                document.querySelectorAll('.message').forEach(msg => msg.remove());
                
                // Criar nova mensagem
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${text}</span>
                    <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; cursor: pointer; color: inherit;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Adicionar ao conteúdo principal
                const contentArea = document.querySelector('.content-area');
                contentArea.insertBefore(messageDiv, contentArea.firstChild);
                
                // Remover automaticamente após 5 segundos
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
            
            navigateTo(page) {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.page === page) {
                        link.classList.add('active');
                    }
                });
                
                this.loadPage(page);
            }
            
            openAssessmentForPatient(patientId) {
                this.openModal('new-assessment-modal', () => {
                    document.getElementById('assessment-patient').value = patientId;
                });
            }
            
            openMenuForPatient(patientId) {
                this.openModal('new-menu-modal', () => {
                    document.getElementById('menu-patient').value = patientId;
                    this.addMealTime();
                });
            }
            
            viewPatient(patientId) {
                const data = this.getData();
                const patient = data.patients.find(p => p.id === patientId);
                
                if (!patient) {
                    this.showMessage('error', 'Paciente não encontrado');
                    return;
                }
                
                const age = this.calculateAge(patient.birthdate);
                const assessments = data.assessments.filter(a => a.patientId === patientId);
                const menus = data.menus.filter(m => m.patientId === patientId);
                
                let content = `
                    <div class="modal-content" style="max-width: 800px;">
                        <span class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</span>
                        <div class="modal-header">
                            <h3>${patient.name}</h3>
                            <p>${age} anos | ${patient.phone} | ${patient.email || 'Sem email'}</p>
                        </div>
                        
                        <div style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                <div>
                                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Informações</h4>
                                    <p><strong>Data de Nascimento:</strong> ${patient.birthdate}</p>
                                    <p><strong>Objetivo:</strong> ${patient.objective}</p>
                                    <p><strong>Status:</strong> <span class="badge badge-success">Ativo</span></p>
                                    ${patient.notes ? `<p><strong>Observações:</strong> ${patient.notes}</p>` : ''}
                                </div>
                                
                                <div>
                                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Estatísticas</h4>
                                    <p><strong>Avaliações Realizadas:</strong> ${assessments.length}</p>
                                    <p><strong>Cardápios Prescritos:</strong> ${menus.length}</p>
                                    <p><strong>Última Avaliação:</strong> ${assessments.length > 0 ? new Date(assessments.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date).toLocaleDateString() : 'Nenhuma'}</p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px; display: flex; gap: 15px;">
                                <button class="btn" onclick="app.exportPatientReport(${patient.id})">
                                    <i class="fas fa-file-pdf"></i> Exportar Ficha
                                </button>
                                <button class="btn btn-accent" onclick="app.openAssessmentForPatient(${patient.id}); this.parentElement.parentElement.parentElement.parentElement.remove()">
                                    <i class="fas fa-weight"></i> Nova Avaliação
                                </button>
                                <button class="btn btn-secondary" onclick="app.openMenuForPatient(${patient.id}); this.parentElement.parentElement.parentElement.parentElement.remove()">
                                    <i class="fas fa-utensils"></i> Novo Cardápio
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Criar modal temporário
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = content;
                document.body.appendChild(modal);
            }
            
            viewMenu(menuId) {
                const data = this.getData();
                const menu = data.menus.find(m => m.id === menuId);
                
                if (!menu) {
                    this.showMessage('error', 'Cardápio não encontrado');
                    return;
                }
                
                const patient = data.patients.find(p => p.id === menu.patientId);
                
                let content = `
                    <div class="modal-content" style="max-width: 800px;">
                        <span class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</span>
                        <div class="modal-header">
                            <h3>${menu.name}</h3>
                            <p>${patient ? patient.name : 'Paciente não informado'} | ${menu.days} dias | ${menu.calories} kcal/dia</p>
                        </div>
                        
                        <div style="padding: 20px;">
                            ${menu.description ? `<p style="margin-bottom: 20px; color: var(--gray-color);">${menu.description}</p>` : ''}
                            
                            <h4 style="color: var(--primary-color); margin-bottom: 15px;">Refeições Diárias</h4>
                `;
                
                if (menu.meals && menu.meals.length > 0) {
                    menu.meals.forEach(meal => {
                        content += `
                            <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--light-gray);">
                                <h5 style="color: var(--primary-color); margin-bottom: 10px;">${meal.time}</h5>
                                <ul style="padding-left: 20px;">
                                    ${meal.items.map(item => `<li style="margin-bottom: 5px;">${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    });
                } else {
                    content += '<p style="color: var(--gray-color); text-align: center; padding: 20px;">Nenhuma refeição cadastrada</p>';
                }
                
                content += `
                            <div style="margin-top: 30px; display: flex; gap: 15px;">
                                <button class="btn" onclick="app.exportMenuPDF(${menu.id})">
                                    <i class="fas fa-file-pdf"></i> Exportar PDF
                                </button>
                                <button class="btn btn-secondary" onclick="app.exportMenuExcel(${menu.id})">
                                    <i class="fas fa-file-excel"></i> Exportar Excel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Criar modal temporário
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = content;
                document.body.appendChild(modal);
            }
            
            exportNutritionalAnalysis() {
                this.showMessage('info', 'Análise nutricional em desenvolvimento. Em breve disponível.');
            }
            
            exportTACOToPDF() {
                this.showMessage('info', 'Exportação da Tabela TACO em PDF em desenvolvimento.');
            }
            
            exportMenuShoppingList() {
                this.showMessage('info', 'Lista de compras em desenvolvimento. Em breve disponível.');
            }
            
            importTACOData() {
                this.showMessage('info', 'Importação de dados TACO em desenvolvimento.');
            }
        }
        
        // Inicializar aplicação
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new NutriVision();
            window.app = app;
            
            // Configurar datas padrão
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value && !input.id.includes('birthdate')) {
                    input.value = today;
                }
            });
            
            // Adicionar evento de busca na tabela TACO
            const tacoSearch = document.getElementById('taco-search');
            if (tacoSearch) {
                tacoSearch.addEventListener('input', (e) => {
                    app.searchTACO(e.target.value);
                });
            }
        });
    </script>
</body>
</html>