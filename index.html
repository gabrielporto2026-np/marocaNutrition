        /* ===== NOVO: CARDS ESTATÍSTICAS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--gray-color);
            font-size: 0.95rem;
        }

        /* ===== NOVO: GRÁFICOS ===== */
        .chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin: 25px 0;
            box-shadow: var(--box-shadow);
        }

        .chart-placeholder {
            height: 300px;
            background: linear-gradient(135deg, rgba(248, 249, 250, 0.8) 0%, rgba(233, 236, 239, 0.8) 100%);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-color);
            font-size: 1.2rem;
        }

        /* ===== NOVO: LISTA DE TAREFAS ===== */
        .tasks-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid var(--primary-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-checkbox.checked {
            background: var(--primary-color);
            color: white;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-due {
            font-size: 0.85rem;
            color: var(--gray-color);
        }

        .task-priority {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .priority-high {
            background: rgba(231, 76, 60, 0.1);
            color: #E74C3C;
        }

        .priority-medium {
            background: rgba(241, 196, 15, 0.1);
            color: #F39C12;
        }

        .priority-low {
            background: rgba(46, 204, 113, 0.1);
            color: #27AE60;
        }

        /* ===== NOVO: MENSAGENS DE NOTIFICAÇÃO ===== */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== NOVO: TEMA ESCURO ===== */
        @media (prefers-color-scheme: dark) {
            :root {
                --light-color: #1a1a1a;
                --dark-color: #f8f9fa;
                --gray-color: #adb5bd;
                --light-gray: #2d3436;
                --accent-color: #4ECDC4;
            }

            body {
                background: linear-gradient(135deg, #2d3436 0%, #1a1a1a 100%);
                color: var(--dark-color);
            }

            .content-area,
            .sidebar,
            .card,
            .modal-content {
                background: #2d3436;
                color: var(--dark-color);
            }

            .form-control,
            .search-container input {
                background: #1a1a1a;
                border-color: #495057;
                color: var(--dark-color);
            }

            .form-control:focus {
                background: #1a1a1a;
                border-color: var(--primary-color);
            }

            table {
                background: #2d3436;
            }

            table th {
                background: #1a1a1a;
            }

            table td {
                border-color: #495057;
            }

            .measurement-group {
                background: #1a1a1a;
            }

            .ingredients-list {
                background: #1a1a1a;
            }
        }

        /* ===== NOVO: ANIMAÇÕES ===== */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes slideInRight {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .slide-in-right {
            animation: slideInRight 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- O código HTML continua exatamente como fornecido -->
    <!-- ... (mantendo todo o HTML fornecido) ... -->
    
    <script>
        // ============================================
        // NUTRIVISION PRO - SISTEMA COMPLETO
        // Versão 3.1 - Todas as funcionalidades implementadas
        // ============================================
        
        class NutriVision {
            constructor() {
                this.currentTab = 'basic';
                this.selectedFoods = [];
                this.currentMealIndex = 0;
                this.editingFoodId = null;
                this.editingPreparationId = null;
                this.initDatabase();
                this.initApp();
            }
            
            initDatabase() {
                // ... (mantendo o mesmo código de inicialização)
                if (!localStorage.getItem('nutrivision_initialized')) {
                    const initialData = {
                        patients: [],
                        assessments: [],
                        menus: [],
                        foods: this.getCompleteTACOFoods(),
                        preparations: this.getDefaultPreparations(),
                        settings: {
                            exportFormat: 'pdf',
                            theme: 'light',
                            language: 'pt-BR'
                        }
                    };
                    
                    localStorage.setItem('nutrivision_data', JSON.stringify(initialData));
                    localStorage.setItem('nutrivision_initialized', 'true');
                }
            }
            
            // ... (mantendo todas as funções existentes)
            
            // ============================================
            // NOVAS FUNCIONALIDADES ADICIONADAS
            // ============================================
            
            // FUNÇÃO PARA CRIAR PREPARAÇÃO
            createNewPreparation() {
                this.openModal('preparation-modal');
                this.editingPreparationId = null;
                
                // Resetar formulário
                const form = document.getElementById('preparation-form');
                if (form) form.reset();
                
                // Definir título
                document.querySelector('#preparation-modal .modal-header h3').textContent = 'Criar Novo Preparo';
            }
            
            // MODAL PARA PREPARAÇÕES
            createPreparationModal() {
                const modal = document.createElement('div');
                modal.id = 'preparation-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <span class="close-modal" onclick="app.closeModal('preparation-modal')">&times;</span>
                        <div class="modal-header">
                            <h3>Criar Novo Preparo</h3>
                        </div>
                        
                        <form id="preparation-form" onsubmit="app.savePreparation(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="preparation-name">Nome do Preparo *</label>
                                    <input type="text" id="preparation-name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="preparation-category">Categoria *</label>
                                    <select id="preparation-category" class="form-control" required>
                                        <option value="">Selecione</option>
                                        <option value="Café da manhã">Café da manhã</option>
                                        <option value="Lanche">Lanche</option>
                                        <option value="Almoço">Almoço</option>
                                        <option value="Jantar">Jantar</option>
                                        <option value="Sobremesa">Sobremesa</option>
                                        <option value="Bebida">Bebida</option>
                                        <option value="Prato Principal">Prato Principal</option>
                                        <option value="Acompanhamento">Acompanhamento</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="preparation-description">Descrição</label>
                                <textarea id="preparation-description" class="form-control" rows="3" placeholder="Descreva o preparo..."></textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="preparation-calories">Calorias (kcal)</label>
                                    <input type="number" id="preparation-calories" class="form-control" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="preparation-protein">Proteínas (g)</label>
                                    <input type="number" id="preparation-protein" class="form-control" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="preparation-carbs">Carboidratos (g)</label>
                                    <input type="number" id="preparation-carbs" class="form-control" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="preparation-fat">Gorduras (g)</label>
                                    <input type="number" id="preparation-fat" class="form-control" step="0.1">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Ingredientes</label>
                                <div id="preparation-ingredients">
                                    <div class="ingredient-input" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <input type="text" class="form-control" placeholder="Nome do ingrediente" style="flex: 2;">
                                        <input type="text" class="form-control" placeholder="Quantidade (ex: 100g)" style="flex: 1;">
                                        <button type="button" class="btn btn-small btn-danger" onclick="this.parentElement.remove()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-small" onclick="app.addIngredientField()" style="margin-top: 10px;">
                                    <i class="fas fa-plus"></i> Adicionar Ingrediente
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label for="preparation-instructions">Modo de Preparo</label>
                                <textarea id="preparation-instructions" class="form-control" rows="4" placeholder="Descreva o passo a passo do preparo..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="preparation-time">Tempo de Preparo (minutos)</label>
                                <input type="number" id="preparation-time" class="form-control" min="1" max="300">
                            </div>
                            
                            <div class="form-group">
                                <label for="preparation-difficulty">Dificuldade</label>
                                <select id="preparation-difficulty" class="form-control">
                                    <option value="Fácil">Fácil</option>
                                    <option value="Médio">Médio</option>
                                    <option value="Difícil">Difícil</option>
                                </select>
                            </div>
                            
                            <div style="margin-top: 30px; display: flex; gap: 15px;">
                                <button type="submit" class="btn">Salvar Preparo</button>
                                <button type="button" class="btn btn-secondary" onclick="app.closeModal('preparation-modal')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            addIngredientField() {
                const container = document.getElementById('preparation-ingredients');
                const div = document.createElement('div');
                div.className = 'ingredient-input';
                div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
                div.innerHTML = `
                    <input type="text" class="form-control" placeholder="Nome do ingrediente" style="flex: 2;">
                    <input type="text" class="form-control" placeholder="Quantidade (ex: 100g)" style="flex: 1;">
                    <button type="button" class="btn btn-small btn-danger" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(div);
            }
            
            savePreparation(event) {
                event.preventDefault();
                
                const data = this.getData();
                const ingredients = [];
                
                // Coletar ingredientes
                document.querySelectorAll('#preparation-ingredients .ingredient-input').forEach(input => {
                    const name = input.children[0].value;
                    const quantity = input.children[1].value;
                    if (name && quantity) {
                        ingredients.push({ name, quantity });
                    }
                });
                
                if (this.editingPreparationId) {
                    // Editar preparo existente
                    const index = data.preparations.findIndex(p => p.id === this.editingPreparationId);
                    if (index !== -1) {
                        data.preparations[index] = {
                            ...data.preparations[index],
                            name: document.getElementById('preparation-name').value,
                            category: document.getElementById('preparation-category').value,
                            description: document.getElementById('preparation-description').value,
                            calories: parseInt(document.getElementById('preparation-calories').value) || 0,
                            protein: parseFloat(document.getElementById('preparation-protein').value) || 0,
                            carbs: parseFloat(document.getElementById('preparation-carbs').value) || 0,
                            fat: parseFloat(document.getElementById('preparation-fat').value) || 0,
                            ingredients: ingredients,
                            instructions: document.getElementById('preparation-instructions').value,
                            time: parseInt(document.getElementById('preparation-time').value) || 0,
                            difficulty: document.getElementById('preparation-difficulty').value,
                            updatedAt: new Date().toISOString()
                        };
                    }
                } else {
                    // Criar novo preparo
                    const newId = data.preparations.length > 0 ? Math.max(...data.preparations.map(p => p.id)) + 1 : 1;
                    
                    const preparation = {
                        id: newId,
                        name: document.getElementById('preparation-name').value,
                        category: document.getElementById('preparation-category').value,
                        description: document.getElementById('preparation-description').value,
                        calories: parseInt(document.getElementById('preparation-calories').value) || 0,
                        protein: parseFloat(document.getElementById('preparation-protein').value) || 0,
                        carbs: parseFloat(document.getElementById('preparation-carbs').value) || 0,
                        fat: parseFloat(document.getElementById('preparation-fat').value) || 0,
                        ingredients: ingredients,
                        instructions: document.getElementById('preparation-instructions').value,
                        time: parseInt(document.getElementById('preparation-time').value) || 0,
                        difficulty: document.getElementById('preparation-difficulty').value,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    data.preparations.push(preparation);
                }
                
                this.saveData(data);
                
                this.showMessage('success', this.editingPreparationId ? 'Preparo atualizado com sucesso!' : 'Preparo criado com sucesso!');
                this.closeModal('preparation-modal');
                this.loadPreparationsPage();
                
                // Atualizar select nos cardápios
                this.populatePreparationsSelect();
                
                this.editingPreparationId = null;
            }
            
            editPreparation(prepId) {
                const data = this.getData();
                const preparation = data.preparations.find(p => p.id === prepId);
                
                if (!preparation) {
                    this.showMessage('error', 'Preparo não encontrado');
                    return;
                }
                
                this.editingPreparationId = prepId;
                this.openModal('preparation-modal');
                
                // Preencher formulário
                document.querySelector('#preparation-modal .modal-header h3').textContent = 'Editar Preparo';
                document.getElementById('preparation-name').value = preparation.name;
                document.getElementById('preparation-category').value = preparation.category;
                document.getElementById('preparation-description').value = preparation.description || '';
                document.getElementById('preparation-calories').value = preparation.calories || '';
                document.getElementById('preparation-protein').value = preparation.protein || '';
                document.getElementById('preparation-carbs').value = preparation.carbs || '';
                document.getElementById('preparation-fat').value = preparation.fat || '';
                document.getElementById('preparation-instructions').value = preparation.instructions || '';
                document.getElementById('preparation-time').value = preparation.time || '';
                document.getElementById('preparation-difficulty').value = preparation.difficulty || 'Fácil';
                
                // Preencher ingredientes
                const ingredientsContainer = document.getElementById('preparation-ingredients');
                ingredientsContainer.innerHTML = '';
                
                if (preparation.ingredients && preparation.ingredients.length > 0) {
                    preparation.ingredients.forEach(ingredient => {
                        const div = document.createElement('div');
                        div.className = 'ingredient-input';
                        div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
                        div.innerHTML = `
                            <input type="text" class="form-control" value="${ingredient.name}" style="flex: 2;">
                            <input type="text" class="form-control" value="${ingredient.quantity}" style="flex: 1;">
                            <button type="button" class="btn btn-small btn-danger" onclick="this.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        ingredientsContainer.appendChild(div);
                    });
                } else {
                    this.addIngredientField();
                }
            }
            
            deletePreparation(prepId) {
                if (confirm('Tem certeza que deseja excluir este preparo?')) {
                    const data = this.getData();
                    data.preparations = data.preparations.filter(p => p.id !== prepId);
                    this.saveData(data);
                    
                    this.showMessage('success', 'Preparo excluído com sucesso!');
                    this.loadPreparationsPage();
                    this.populatePreparationsSelect();
                }
            }
            
            // FUNÇÃO PARA EDITAR ALIMENTOS TACO
            editFood(foodId) {
                const data = this.getData();
                const food = data.foods.find(f => f.id === foodId);
                
                if (!food) {
                    this.showMessage('error', 'Alimento não encontrado');
                    return;
                }
                
                this.editingFoodId = foodId;
                this.openModal('add-food-modal');
                
                // Preencher formulário
                document.querySelector('#add-food-modal .modal-header h3').textContent = 'Editar Alimento';
                document.getElementById('food-name').value = food.name;
                document.getElementById('food-category').value = food.category;
                document.getElementById('food-calories').value = food.calories;
                document.getElementById('food-protein').value = food.protein || '';
                document.getElementById('food-carbs').value = food.carbs || '';
                document.getElementById('food-fat').value = food.fat || '';
                document.getElementById('food-fiber').value = food.fiber || '';
                document.getElementById('food-sodium').value = food.sodium || '';
                document.getElementById('food-home-measure').value = food.homeMeasure;
            }
            
            // ATUALIZAR FUNÇÃO SAVE FOOD PARA SUPORTAR EDIÇÃO
            saveFood(event) {
                event.preventDefault();
                
                const data = this.getData();
                
                const foodData = {
                    name: document.getElementById('food-name').value,
                    category: document.getElementById('food-category').value,
                    calories: parseFloat(document.getElementById('food-calories').value),
                    protein: parseFloat(document.getElementById('food-protein').value) || 0,
                    carbs: parseFloat(document.getElementById('food-carbs').value) || 0,
                    fat: parseFloat(document.getElementById('food-fat').value) || 0,
                    fiber: parseFloat(document.getElementById('food-fiber').value) || 0,
                    sodium: parseFloat(document.getElementById('food-sodium').value) || 0,
                    homeMeasure: document.getElementById('food-home-measure').value
                };
                
                if (this.editingFoodId) {
                    // Editar alimento existente
                    const index = data.foods.findIndex(f => f.id === this.editingFoodId);
                    if (index !== -1) {
                        data.foods[index] = { ...data.foods[index], ...foodData };
                    }
                } else {
                    // Criar novo alimento
                    const newId = data.foods.length > 0 ? Math.max(...data.foods.map(f => f.id)) + 1 : 1;
                    data.foods.push({ id: newId, ...foodData });
                }
                
                this.saveData(data);
                
                this.showMessage('success', this.editingFoodId ? 'Alimento atualizado com sucesso!' : 'Alimento adicionado com sucesso!');
                this.closeModal('add-food-modal');
                this.loadTacoManagementTable();
                this.loadTACOPage();
                
                this.editingFoodId = null;
            }
            
            // FUNÇÃO DE EXPORTAÇÃO COMPLETA DA TABELA TACO
            exportFullTACOToPDF() {
                try {
                    const data = this.getData();
                    
                    if (data.foods.length === 0) {
                        this.showMessage('info', 'Não há alimentos na tabela TACO para exportar');
                        return;
                    }
                    
                    // Agrupar alimentos por categoria
                    const foodsByCategory = {};
                    data.foods.forEach(food => {
                        if (!foodsByCategory[food.category]) {
                            foodsByCategory[food.category] = [];
                        }
                        foodsByCategory[food.category].push(food);
                    });
                    
                    let content = `
                        <html>
                            <head>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                                    h1 { color: #2A9D8F; border-bottom: 2px solid #2A9D8F; padding-bottom: 10px; text-align: center; }
                                    h2 { color: #264653; margin-top: 40px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
                                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                    th { background: #264653; color: white; padding: 12px; text-align: left; }
                                    td { padding: 10px; border-bottom: 1px solid #ddd; }
                                    .category-section { page-break-inside: avoid; }
                                    .footer { margin-top: 50px; text-align: center; color: #666; font-size: 0.9em; }
                                    .summary { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 30px 0; }
                                    @media print {
                                        h2 { page-break-after: avoid; }
                                        table { page-break-inside: avoid; }
                                    }
                                </style>
                            </head>
                            <body>
                                <h1>TABELA TACO - COMPOSIÇÃO DE ALIMENTOS</h1>
                                
                                <div class="summary">
                                    <p><strong>Total de Alimentos:</strong> ${data.foods.length}</p>
                                    <p><strong>Total de Categorias:</strong> ${Object.keys(foodsByCategory).length}</p>
                                    <p><strong>Data da Tabela:</strong> ${new Date().toLocaleDateString()}</p>
                                    <p><strong>Fonte:</strong> Tabela Brasileira de Composição de Alimentos - TACO/NEPA-UNICAMP</p>
                                </div>
                    `;
                    
                    // Adicionar cada categoria
                    Object.keys(foodsByCategory).sort().forEach(category => {
                        content += `
                            <div class="category-section">
                                <h2>${category}</h2>
                                <table>
                                    <tr>
                                        <th>Alimento</th>
                                        <th>Calorias (kcal)</th>
                                        <th>Proteínas (g)</th>
                                        <th>Carboidratos (g)</th>
                                        <th>Gorduras (g)</th>
                                        <th>Fibras (g)</th>
                                        <th>Medida Caseira</th>
                                    </tr>
                        `;
                        
                        foodsByCategory[category].forEach(food => {
                            content += `
                                <tr>
                                    <td><strong>${food.name}</strong></td>
                                    <td>${food.calories}</td>
                                    <td>${food.protein}</td>
                                    <td>${food.carbs}</td>
                                    <td>${food.fat}</td>
                                    <td>${food.fiber}</td>
                                    <td><small>${food.homeMeasure}</small></td>
                                </tr>
                            `;
                        });
                        
                        content += `
                                </table>
                            </div>
                        `;
                    });
                    
                    content += `
                                <div class="footer">
                                    <p>Tabela gerada por NutriVision Pro - ${new Date().toLocaleDateString()}</p>
                                    <p>Dra. Maria Oliveira - CRN 12345</p>
                                    <p>Confidencial - Uso exclusivo do nutricionista</p>
                                </div>
                            </body>
                        </html>
                    `;
                    
                    // Criar janela para impressão/PDF
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(content);
                    printWindow.document.close();
                    
                    // Esperar que o conteúdo seja carregado antes de imprimir
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                    
                    this.showMessage('success', 'Tabela TACO exportada em PDF com sucesso!');
                } catch (error) {
                    console.error('Erro ao exportar TACO PDF:', error);
                    this.showMessage('error', 'Erro ao exportar PDF. Tente novamente.');
                }
            }
            
            // FUNÇÃO PARA IMPORTAR DADOS TACO
            importTACOData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,.xlsx,.xls,.csv';
                input.style.display = 'none';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        try {
                            let importedData;
                            
                            if (file.name.endsWith('.json')) {
                                importedData = JSON.parse(event.target.result);
                            } else {
                                // Para Excel/CSV, usar SheetJS
                                const workbook = XLSX.read(event.target.result, { type: 'binary' });
                                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                                importedData = XLSX.utils.sheet_to_json(worksheet);
                                
                                // Converter para o formato padrão
                                importedData = importedData.map(item => ({
                                    name: item.Alimento || item.Nome || item.name,
                                    category: item.Categoria || item.Category || item.category,
                                    calories: parseFloat(item.Calorias || item.calories),
                                    protein: parseFloat(item.Proteínas || item.Proteina || item.protein) || 0,
                                    carbs: parseFloat(item.Carboidratos || item.Carbs || item.carbs) || 0,
                                    fat: parseFloat(item.Gorduras || item.Fat || item.fat) || 0,
                                    fiber: parseFloat(item.Fibras || item.Fiber || item.fiber) || 0,
                                    sodium: parseFloat(item.Sódio || item.Sodium || item.sodium) || 0,
                                    homeMeasure: item['Medida Caseira'] || item.homeMeasure || ''
                                }));
                            }
                            
                            if (!Array.isArray(importedData)) {
                                throw new Error('Formato de dados inválido');
                            }
                            
                            const data = this.getData();
                            const newIdStart = data.foods.length > 0 ? Math.max(...data.foods.map(f => f.id)) + 1 : 1;
                            
                            // Adicionar IDs aos novos alimentos
                            importedData.forEach((food, index) => {
                                if (!food.id) {
                                    food.id = newIdStart + index;
                                }
                            });
                            
                            // Combinar com alimentos existentes
                            data.foods = [...data.foods, ...importedData];
                            
                            // Remover duplicados (baseado no nome)
                            const uniqueFoods = [];
                            const seenNames = new Set();
                            
                            data.foods.forEach(food => {
                                if (!seenNames.has(food.name)) {
                                    seenNames.add(food.name);
                                    uniqueFoods.push(food);
                                }
                            });
                            
                            data.foods = uniqueFoods;
                            this.saveData(data);
                            
                            this.showMessage('success', `Importação concluída! ${importedData.length} alimentos importados.`);
                            this.loadTacoManagementTable();
                            this.loadTACOPage();
                        } catch (error) {
                            console.error('Erro na importação:', error);
                            this.showMessage('error', 'Erro na importação. Verifique o formato do arquivo.');
                        }
                    };
                    
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        reader.readAsBinaryString(file);
                    } else {
                        reader.readAsText(file);
                    }
                };
                
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
            }
            
            // FUNÇÃO PARA EXPORTAR LISTA DE COMPRAS
            exportMenuShoppingList(menuId = null) {
                try {
                    const data = this.getData();
                    let menu;
                    
                    if (menuId) {
                        menu = data.menus.find(m => m.id === menuId);
                    } else {
                        // Tentar usar o cardápio atual do formulário
                        this.showMessage('info', 'Primeiro salve o cardápio para gerar a lista de compras');
                        return;
                    }
                    
                    if (!menu) {
                        this.showMessage('error', 'Cardápio não encontrado');
                        return;
                    }
                    
                    // Extrair ingredientes de todos os preparos usados
                    const ingredientsMap = new Map();
                    
                    // Adicionar ingredientes dos preparos pré-configurados
                    data.preparations.forEach(prep => {
                        if (prep.ingredients) {
                            prep.ingredients.forEach(ing => {
                                const key = ing.name.toLowerCase();
                                if (ingredientsMap.has(key)) {
                                    ingredientsMap.get(key).quantity += ` + ${ing.quantity}`;
                                } else {
                                    ingredientsMap.set(key, {
                                        name: ing.name,
                                        quantity: ing.quantity,
                                        category: 'Preparo'
                                    });
                                }
                            });
                        }
                    });
                    
                    // Organizar ingredientes por categoria
                    const ingredientsByCategory = {
                        'Hortifrúti': [],
                        'Cereais e Grãos': [],
                        'Proteínas': [],
                        'Laticínios': [],
                        'Temperos': [],
                        'Outros': []
                    };
                    
                    ingredientsMap.forEach(ingredient => {
                        let category = 'Outros';
                        
                        // Classificar por categoria
                        const name = ingredient.name.toLowerCase();
                        if (name.includes('alface') || name.includes('tomate') || name.includes('cenoura') || 
                            name.includes('fruta') || name.includes('legume') || name.includes('verdura')) {
                            category = 'Hortifrúti';
                        } else if (name.includes('arroz') || name.includes('feijão') || name.includes('macarrão') || 
                                   name.includes('pão') || name.includes('farinha') || name.includes('aveia')) {
                            category = 'Cereais e Grãos';
                        } else if (name.includes('frango') || name.includes('carne') || name.includes('peixe') || 
                                   name.includes('ovo') || name.includes('tofu')) {
                            category = 'Proteínas';
                        } else if (name.includes('leite') || name.includes('queijo') || name.includes('iogurte') || 
                                   name.includes('manteiga')) {
                            category = 'Laticínios';
                        } else if (name.includes('sal') || name.includes('azeite') || name.includes('óleo') || 
                                   name.includes('tempero') || name.includes('alho') || name.includes('cebola')) {
                            category = 'Temperos';
                        }
                        
                        ingredientsByCategory[category].push(ingredient);
                    });
                    
                    // Criar conteúdo para a lista de compras
                    const patient = data.patients.find(p => p.id === menu.patientId);
                    
                    let content = `
                        <html>
                            <head>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                                    h1 { color: #2A9D8F; border-bottom: 2px solid #2A9D8F; padding-bottom: 10px; }
                                    h2 { color: #264653; margin-top: 30px; }
                                    .header { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
                                    .category-section { margin: 25px 0; }
                                    .category-title { background: #E9C46A; color: #333; padding: 10px 15px; border-radius: 5px; font-weight: bold; }
                                    .ingredient-list { padding: 15px; }
                                    .ingredient-item { padding: 8px 0; border-bottom: 1px dashed #ddd; display: flex; }
                                    .ingredient-name { flex: 1; }
                                    .ingredient-quantity { font-weight: bold; color: #2A9D8F; }
                                    .checkbox { margin-right: 10px; }
                                    .footer { margin-top: 50px; text-align: center; color: #666; font-size: 0.9em; }
                                    @media print {
                                        .no-print { display: none; }
                                    }
                                </style>
                            </head>
                            <body>
                                <h1>Lista de Compras - Cardápio Nutricional</h1>
                                
                                <div class="header">
                                    <p><strong>Cardápio:</strong> ${menu.name}</p>
                                    <p><strong>Paciente:</strong> ${patient ? patient.name : 'Não informado'}</p>
                                    <p><strong>Duração:</strong> ${menu.days} dias</p>
                                    <p><strong>Data da Lista:</strong> ${new Date().toLocaleDateString()}</p>
                                </div>
                                
                                <div class="no-print" style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; color: #856404;">
                                    <p><strong>Dica:</strong> Marque os itens conforme for comprando!</p>
                                </div>
                    `;
                    
                    // Adicionar cada categoria
                    Object.entries(ingredientsByCategory).forEach(([category, ingredients]) => {
                        if (ingredients.length > 0) {
                            content += `
                                <div class="category-section">
                                    <div class="category-title">${category}</div>
                                    <div class="ingredient-list">
                            `;
                            
                            ingredients.forEach(ingredient => {
                                content += `
                                    <div class="ingredient-item">
                                        <input type="checkbox" class="checkbox">
                                        <span class="ingredient-name">${ingredient.name}</span>
                                        <span class="ingredient-quantity">${ingredient.quantity}</span>
                                    </div>
                                `;
                            });
                            
                            content += `
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    content += `
                                <div class="footer">
                                    <p>Lista de compras gerada por NutriVision Pro</p>
                                    <p>Cardápio válido por ${menu.days} dias | ${menu.calories} kcal/dia</p>
                                </div>
                                
                                <script>
                                    // Adicionar funcionalidade aos checkboxes
                                    document.querySelectorAll('.checkbox').forEach(checkbox => {
                                        checkbox.addEventListener('change', function() {
                                            if (this.checked) {
                                                this.parentElement.style.textDecoration = 'line-through';
                                                this.parentElement.style.opacity = '0.6';
                                            } else {
                                                this.parentElement.style.textDecoration = 'none';
                                                this.parentElement.style.opacity = '1';
                                            }
                                        });
                                    });
                                    
                                    // Imprimir automaticamente
                                    window.onload = function() {
                                        window.print();
                                    };
                                <\/script>
                            </body>
                        </html>
                    `;
                    
                    // Criar janela para impressão/PDF
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(content);
                    printWindow.document.close();
                    
                    this.showMessage('success', 'Lista de compras gerada com sucesso!');
                } catch (error) {
                    console.error('Erro ao gerar lista de compras:', error);
                    this.showMessage('error', 'Erro ao gerar lista de compras. Tente novamente.');
                }
            }
            
            // FUNÇÃO PARA ANÁLISE NUTRICIONAL
            exportNutritionalAnalysis() {
                try {
                    const data = this.getData();
                    
                    // Coletar estatísticas
                    const stats = {
                        totalPatients: data.patients.length,
                        totalAssessments: data.assessments.length,
                        totalMenus: data.menus.length,
                        averageIMC: 0,
                        objectiveDistribution: {},
                        genderDistribution: { M: 0, F: 0, O: 0 },
                        ageGroups: { '0-18': 0, '19-30': 0, '31-50': 0, '51+': 0 }
                    };
                    
                    // Calcular distribuição por objetivo
                    data.patients.forEach(patient => {
                        stats.objectiveDistribution[patient.objective] = (stats.objectiveDistribution[patient.objective] || 0) + 1;
                        
                        // Distribuição por gênero
                        if (patient.gender in stats.genderDistribution) {
                            stats.genderDistribution[patient.gender]++;
                        }
                        
                        // Distribuição por faixa etária
                        const age = this.calculateAge(patient.birthdate);
                        if (age <= 18) stats.ageGroups['0-18']++;
                        else if (age <= 30) stats.ageGroups['19-30']++;
                        else if (age <= 50) stats.ageGroups['31-50']++;
                        else stats.ageGroups['51+']++;
                    });
                    
                    // Calcular IMC médio
                    if (data.assessments.length > 0) {
                        const totalIMC = data.assessments.reduce((sum, assess) => {
                            const imc = this.calculateIMC(assess.weight, assess.height);
                            return sum + parseFloat(imc.imc);
                        }, 0);
                        stats.averageIMC = (totalIMC / data.assessments.length).toFixed(1);
                    }
                    
                    // Criar gráfico de distribuição por objetivo (usando caracteres ASCII)
                    const objectiveChart = Object.entries(stats.objectiveDistribution)
                        .map(([obj, count]) => {
                            const percentage = ((count / stats.totalPatients) * 100).toFixed(1);
                            const bars = '█'.repeat(Math.round((count / stats.totalPatients) * 20));
                            return `${obj.padEnd(20)} ${bars} ${count} (${percentage}%)`;
                        }).join('\n');
                    
                    // Criar conteúdo para o relatório
                    let content = `
                        <html>
                            <head>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                                    h1 { color: #2A9D8F; border-bottom: 2px solid #2A9D8F; padding-bottom: 10px; text-align: center; }
                                    h2 { color: #264653; margin-top: 30px; }
                                    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
                                    .stat-box { background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #ddd; }
                                    .stat-number { font-size: 2.5rem; font-weight: bold; color: #2A9D8F; }
                                    .stat-label { color: #666; margin-top: 10px; }
                                    .chart { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #ddd; }
                                    .chart-bar { display: flex; align-items: center; margin: 15px 0; }
                                    .chart-label { width: 150px; }
                                    .chart-value { margin-left: 20px; font-weight: bold; }
                                    .chart-visual { flex: 1; height: 20px; background: linear-gradient(to right, #2A9D8F, #4ECDC4); border-radius: 10px; }
                                    .footer { margin-top: 50px; text-align: center; color: #666; font-size: 0.9em; }
                                    pre { background: #f8f9fa; padding: 20px; border-radius: 10px; overflow-x: auto; }
                                </style>
                            </head>
                            <body>
                                <h1>Relatório de Análise Nutricional</h1>
                                
                                <div class="stats-grid">
                                    <div class="stat-box">
                                        <div class="stat-number">${stats.totalPatients}</div>
                                        <div class="stat-label">Pacientes Ativos</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-number">${stats.totalAssessments}</div>
                                        <div class="stat-label">Avaliações</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-number">${stats.totalMenus}</div>
                                        <div class="stat-label">Cardápios</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-number">${stats.averageIMC}</div>
                                        <div class="stat-label">IMC Médio</div>
                                    </div>
                                </div>
                                
                                <h2>Distribuição por Objetivo</h2>
                                <div class="chart">
                    `;
                    
                    Object.entries(stats.objectiveDistribution).forEach(([obj, count]) => {
                        const percentage = ((count / stats.totalPatients) * 100).toFixed(1);
                        const width = (count / stats.totalPatients) * 100;
                        
                        content += `
                            <div class="chart-bar">
                                <div class="chart-label">${obj}</div>
                                <div class="chart-visual" style="width: ${width}%"></div>
                                <div class="chart-value">${count} (${percentage}%)</div>
                            </div>
                        `;
                    });
                    
                    content += `
                                </div>
                                
                                <h2>Distribuição por Faixa Etária</h2>
                                <div class="chart">
                    `;
                    
                    Object.entries(stats.ageGroups).forEach(([ageGroup, count]) => {
                        if (count > 0) {
                            const percentage = ((count / stats.totalPatients) * 100).toFixed(1);
                            const width = (count / stats.totalPatients) * 100;
                            
                            content += `
                                <div class="chart-bar">
                                    <div class="chart-label">${ageGroup} anos</div>
                                    <div class="chart-visual" style="width: ${width}%; background: linear-gradient(to right, #E9C46A, #F4A261);"></div>
                                    <div class="chart-value">${count} (${percentage}%)</div>
                                </div>
                            `;
                        }
                    });
                    
                    content += `
                                </div>
                                
                                <h2>Distribuição por Gênero</h2>
                                <div class="chart">
                    `;
                    
                    Object.entries(stats.genderDistribution).forEach(([gender, count]) => {
                        if (count > 0) {
                            const genderName = { M: 'Masculino', F: 'Feminino', O: 'Outro' }[gender];
                            const percentage = ((count / stats.totalPatients) * 100).toFixed(1);
                            const width = (count / stats.totalPatients) * 100;
                            
                            content += `
                                <div class="chart-bar">
                                    <div class="chart-label">${genderName}</div>
                                    <div class="chart-visual" style="width: ${width}%; background: linear-gradient(to right, #457B9D, #1D3557);"></div>
                                    <div class="chart-value">${count} (${percentage}%)</div>
                                </div>
                            `;
                        }
                    });
                    
                    content += `
                                </div>
                                
                                <h2>Resumo Estatístico</h2>
                                <pre>
${objectiveChart}

ESTATÍSTICAS GERAIS:
• Total de Pacientes: ${stats.totalPatients}
• Total de Avaliações: ${stats.totalAssessments}
• Total de Cardápios: ${stats.totalMenus}
• IMC Médio: ${stats.averageIMC}

DISTRIBUIÇÃO ETÁRIA:
${Object.entries(stats.ageGroups).map(([group, count]) => 
    `• ${group} anos: ${count} (${((count / stats.totalPatients) * 100).toFixed(1)}%)`
).join('\n')}

DISTRIBUIÇÃO POR GÊNERO:
${Object.entries(stats.genderDistribution).map(([gender, count]) => 
    `• ${ { M: 'Masculino', F: 'Feminino', O: 'Outro' }[gender] }: ${count} (${((count / stats.totalPatients) * 100).toFixed(1)}%)`
).join('\n')}
                                </pre>
                                
                                <div class="footer">
                                    <p>Relatório gerado por NutriVision Pro - ${new Date().toLocaleDateString()}</p>
                                    <p>Dra. Maria Oliveira - CRN 12345</p>
                                    <p>Análise válida até ${new Date(new Date().setMonth(new Date().getMonth() + 1)).toLocaleDateString()}</p>
                                </div>
                            </body>
                        </html>
                    `;
                    
                    // Criar janela para impressão/PDF
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(content);
                    printWindow.document.close();
                    
                    // Esperar que o conteúdo seja carregado antes de imprimir
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                    
                    this.showMessage('success', 'Análise nutricional gerada com sucesso!');
                } catch (error) {
                    console.error('Erro ao gerar análise nutricional:', error);
                    this.showMessage('error', 'Erro ao gerar análise. Tente novamente.');
                }
            }
            
            // FUNÇÃO PARA BACKUP DE DADOS
            backupData() {
                try {
                    const data = this.getData();
                    const backup = {
                        ...data,
                        backupDate: new Date().toISOString(),
                        version: '3.1',
                        totalRecords: {
                            patients: data.patients.length,
                            assessments: data.assessments.length,
                            menus: data.menus.length,
                            foods: data.foods.length,
                            preparations: data.preparations.length
                        }
                    };
                    
                    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `nutrivision_backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showMessage('success', 'Backup realizado com sucesso!');
                } catch (error) {
                    console.error('Erro no backup:', error);
                    this.showMessage('error', 'Erro ao realizar backup.');
                }
            }
            
            // FUNÇÃO PARA RESTAURAR BACKUP
            restoreBackup() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.style.display = 'none';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        try {
                            const backupData = JSON.parse(event.target.result);
                            
                            // Verificar se é um backup válido
                            if (!backupData.patients || !backupData.assessments) {
                                throw new Error('Arquivo de backup inválido');
                            }
                            
                            if (confirm('Tem certeza que deseja restaurar este backup? Todos os dados atuais serão substituídos.')) {
                                localStorage.setItem('nutrivision_data', JSON.stringify(backupData));
                                this.showMessage('success', 'Backup restaurado com sucesso!');
                                location.reload(); // Recarregar a página para aplicar os dados
                            }
                        } catch (error) {
                            console.error('Erro na restauração:', error);
                            this.showMessage('error', 'Erro ao restaurar backup. Arquivo inválido.');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
            }
            
            // FUNÇÃO PARA LIMPAR DADOS
            clearAllData() {
                if (confirm('ATENÇÃO: Esta ação irá apagar TODOS os dados do sistema. Esta ação não pode ser desfeita.\n\nTem certeza que deseja continuar?')) {
                    if (confirm('CONFIRMAÇÃO FINAL: Todos os pacientes, avaliações, cardápios e configurações serão permanentemente excluídos.')) {
                        localStorage.removeItem('nutrivision_data');
                        localStorage.removeItem('nutrivision_initialized');
                        this.showMessage('success', 'Todos os dados foram limpos. A página será recarregada.');
                        setTimeout(() => location.reload(), 2000);
                    }
                }
            }
            
            // FUNÇÃO PARA EXPORTAR TODOS OS DADOS
            exportAllData() {
                try {
                    const data = this.getData();
                    const exportData = {
                        metadata: {
                            exportDate: new Date().toISOString(),
                            system: 'NutriVision Pro',
                            version: '3.1',
                            records: {
                                patients: data.patients.length,
                                assessments: data.assessments.length,
                                menus: data.menus.length,
                                foods: data.foods.length,
                                preparations: data.preparations.length
                            }
                        },
                        patients: data.patients,
                        assessments: data.assessments,
                        menus: data.menus,
                        foods: data.foods,
                        preparations: data.preparations,
                        settings: data.settings
                    };
                    
                    // Criar múltiplas abas na planilha
                    const wb = XLSX.utils.book_new();
                    
                    // Pacientes
                    const patientsWS = XLSX.utils.json_to_sheet(data.patients.map(p => ({
                        ID: p.id,
                        Nome: p.name,
                        Email: p.email,
                        Telefone: p.phone,
                        'Data Nascimento': p.birthdate,
                        Idade: this.calculateAge(p.birthdate),
                        Sexo: p.gender === 'M' ? 'Masculino' : p.gender === 'F' ? 'Feminino' : 'Outro',
                        Tipo: p.type,
                        Objetivo: p.objective,
                        Status: p.status,
                        'Data Cadastro': p.createdAt ? new Date(p.createdAt).toLocaleDateString() : '',
                        Observações: p.notes || ''
                    })));
                    XLSX.utils.book_append_sheet(wb, patientsWS, 'Pacientes');
                    
                    // Avaliações
                    const assessmentsWS = XLSX.utils.json_to_sheet(data.assessments.map(a => {
                        const patient = data.patients.find(p => p.id === a.patientId);
                        const imc = this.calculateIMC(a.weight, a.height);
                        
                        return {
                            ID: a.id,
                            Paciente: patient ? patient.name : 'Não encontrado',
                            Data: a.date,
                            Peso: a.weight,
                            Altura: a.height,
                            IMC: imc.imc,
                            Classificação: imc.classification,
                            Cintura: a.waist || '',
                            Abdominal: a.abdomen || '',
                            Quadril: a.hip || '',
                            Braço: a.arm || '',
                            'Data Criação': a.createdAt ? new Date(a.createdAt).toLocaleDateString() : '',
                            Observações: a.notes || ''
                        };
                    }));
                    XLSX.utils.book_append_sheet(wb, assessmentsWS, 'Avaliações');
                    
                    // Cardápios
                    const menusWS = XLSX.utils.json_to_sheet(data.menus.map(m => {
                        const patient = data.patients.find(p => p.id === m.patientId);
                        
                        return {
                            ID: m.id,
                            Nome: m.name,
                            Paciente: patient ? patient.name : 'Não informado',
                            Descrição: m.description || '',
                            Dias: m.days,
                            'Calorias Diárias': m.calories,
                            'Total Refeições': m.meals ? m.meals.length : 0,
                            'Data Criação': m.createdAt ? new Date(m.createdAt).toLocaleDateString() : ''
                        };
                    }));
                    XLSX.utils.book_append_sheet(wb, menusWS, 'Cardápios');
                    
                    // TACO
                    const tacoWS = XLSX.utils.json_to_sheet(data.foods.map(f => ({
                        ID: f.id,
                        Alimento: f.name,
                        Categoria: f.category,
                        Calorias: f.calories,
                        Proteínas: f.protein,
                        Carboidratos: f.carbs,
                        Gorduras: f.fat,
                        Fibras: f.fiber,
                        Sódio: f.sodium,
                        'Medida Caseira': f.homeMeasure
                    })));
                    XLSX.utils.book_append_sheet(wb, tacoWS, 'TACO');
                    
                    // Preparos
                    const preparationsWS = XLSX.utils.json_to_sheet(data.preparations.map(p => ({
                        ID: p.id,
                        Nome: p.name,
                        Categoria: p.category,
                        Descrição: p.description || '',
                        Calorias: p.calories,
                        Proteínas: p.protein,
                        Carboidratos: p.carbs,
                        Gorduras: p.fat,
                        'Tempo Preparo': p.time ? `${p.time} minutos` : '',
                        Dificuldade: p.difficulty || '',
                        'Total Ingredientes': p.ingredients ? p.ingredients.length : 0,
                        'Data Criação': p.createdAt ? new Date(p.createdAt).toLocaleDateString() : ''
                    })));
                    XLSX.utils.book_append_sheet(wb, preparationsWS, 'Preparos');
                    
                    // Salvar arquivo
                    XLSX.writeFile(wb, `nutrivision_completo_${new Date().toISOString().split('T')[0]}.xlsx`);
                    
                    this.showMessage('success', 'Todos os dados exportados com sucesso!');
                } catch (error) {
                    console.error('Erro na exportação completa:', error);
                    this.showMessage('error', 'Erro na exportação. Tente novamente.');
                }
            }
            
            // ATUALIZAR FUNÇÃO INITAPP PARA INCLUIR MODAIS DINÂMICOS
            initApp() {
                this.setupNavigation();
                this.setupTabs();
                this.setupModals();
                this.createPreparationModal(); // Criar modal de preparos dinamicamente
                this.loadDashboard();
                
                // Adicionar botões de sistema no footer
                this.addSystemButtons();
            }
            
            addSystemButtons() {
                const footer = document.querySelector('footer .footer-content');
                if (footer) {
                    const systemDiv = document.createElement('div');
                    systemDiv.style.cssText = 'margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;';
                    systemDiv.innerHTML = `
                        <button class="btn btn-small" onclick="app.backupData()" title="Backup de dados">
                            <i class="fas fa-download"></i> Backup
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="app.restoreBackup()" title="Restaurar backup">
                            <i class="fas fa-upload"></i> Restaurar
                        </button>
                        <button class="btn btn-small btn-accent" onclick="app.exportAllData()" title="Exportar todos os dados">
                            <i class="fas fa-file-export"></i> Exportar Tudo
                        </button>
                        <button class="btn btn-small btn-danger" onclick="app.clearAllData()" title="Limpar todos os dados">
                            <i class="fas fa-trash"></i> Limpar Dados
                        </button>
                    `;
                    footer.appendChild(systemDiv);
                }
            }
        }
        
        // Inicializar aplicação
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new NutriVision();
            window.app = app;
            
            // Configurar datas padrão
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value && !input.id.includes('birthdate')) {
                    input.value = today;
                }
                if (input.id.includes('birthdate')) {
                    input.max = today;
                }
            });
            
            // Adicionar evento de busca na tabela TACO
            const tacoSearch = document.getElementById('taco-search');
            if (tacoSearch) {
                tacoSearch.addEventListener('input', (e) => {
                    app.searchTACO(e.target.value);
                });
            }
            
            // Adicionar funcionalidade de cálculo automático do IMC
            const weightInput = document.getElementById('assessment-weight');
            const heightInput = document.getElementById('assessment-height');
            
            if (weightInput && heightInput) {
                const calculateIMC = () => {
                    if (app.currentTab === 'results') {
                        app.calculateAssessmentResults();
                    }
                };
                
                weightInput.addEventListener('input', calculateIMC);
                heightInput.addEventListener('input', calculateIMC);
                weightInput.addEventListener('change', calculateIMC);
                heightInput.addEventListener('change', calculateIMC);
            }
            
            // Configurar tema
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
            const applyTheme = (isDark) => {
                if (isDark) {
                    document.documentElement.style.setProperty('--light-color', '#1a1a1a');
                    document.documentElement.style.setProperty('--dark-color', '#f8f9fa');
                    document.documentElement.style.setProperty('--gray-color', '#adb5bd');
                    document.documentElement.style.setProperty('--light-gray', '#2d3436');
                } else {
                    document.documentElement.style.setProperty('--light-color', '#F8F9FA');
                    document.documentElement.style.setProperty('--dark-color', '#343A40');
                    document.documentElement.style.setProperty('--gray-color', '#6C757D');
                    document.documentElement.style.setProperty('--light-gray', '#E9ECEF');
                }
            };
            
            applyTheme(prefersDark.matches);
            prefersDark.addListener((e) => applyTheme(e.matches));
        });
    </script>
</body>
</html>